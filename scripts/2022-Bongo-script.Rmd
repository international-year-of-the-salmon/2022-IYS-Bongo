---
title: "2022-IYS-Bongo"
author: "Tim van der Stap"
date: "2022-09-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
library(tidyverse)
library(lubridate)
library(worrms)
library(dplyr)
library(obistools)
library(readxl)
library(parsedate)
library(googledrive)
library(here)
library(Hmisc)
```

This .Rmd file describes the workflow to standardize the 2022 zooplankton taxonomy and abundance data from the International Year of the Salmon High Seas Expedition to Darwin Core, to allow publication to the Ocean Biodiversity Information System (OBIS). This file is divided into three sections that describe creating the following data tables: 1) Event Core, 2) occurrence extension and 3) extended measurement or fact extension. The script uses the following data sources:

## Read in files:

``` {r read_file, warning = FALSE}
# For the metadata:
tinro2022_bongo_metadata <- read_excel(here("original_data", "archived", "7-14 2022 Bongo Logbook-TINRO_clean.xlsx"), sheet = "Bongo metadata")
shimada2022_bongo_metadata <- read_excel(here("IYS_data_template", "IYS2022_Shimada_data.xlsx"), sheet = "4. SAMPLING EVENT INFO")
nw2022_bongo_metadata <- read_excel(here("IYS_data_template", "IYS2022_NW_Data.xlsx"), sheet = "Sampling_Event_Info")
franklin2022_bongo_meta <- read_excel(here("original_data", "archived", "2022002 IYS Franklin abund biomass by species n life stage .xlsx"), sheet = "metadata")

# For the data:
IYS2022_occ <- read.csv(here("original_data", "IYS_Standardized_Zoop_Taxa_Abundance_2022.csv"))
```

## Section 1. Event Core

The 2022 zooplankton data were collected during multiple sampling events, where a paired Bongo net is deployed and retrieved vertically. Given this set up, we standardize the data with an Event data file at its core. This data table will include metadata on the sampling event (date, time, geographic coordinates, sampling effort). We have to make sure that the date/time follows the ISO-8601 standards, and that all sampling events have a unique identifier (eventID) under which the other data files will be nested. The following chunk of code standardizes the metadata from the various vessels:

``` {r event core, eval = FALSE}

# For the R/V TINRO:
tinro2022_bongo_event <- tinro2022_bongo_metadata %>%
  select(-`T, surf`) %>%
  mutate(Time = format(`Time, UTC`, "%H:%M:%S"),
         eventDate = format_iso_8601(as.POSIXct(paste(Date, Time),
                                                format = "%Y-%m-%d %H:%M:%S",
                                                tz = "UTC")),
         eventDate = str_replace(eventDate, "\\+00:00", "Z"))

tinro2022_bongo_event$Year <- as.numeric(format(as.Date(tinro2022_bongo_event$eventDate), "%Y"))
tinro2022_bongo_event$Month <- as.numeric(format(as.Date(tinro2022_bongo_event$eventDate), "%m"))
tinro2022_bongo_event$Day <- as.numeric(format(as.Date(tinro2022_bongo_event$eventDate), "%d"))

tinro2022_bongo_event <- tinro2022_bongo_event %>%
  mutate(zone = 3,
         eventID = paste("IYS2022", "TINRO", zone, Station, Gear, `Net number`, sep = "-"),
         minimumDepthInMeters = 0,
         geodeticDatum = "WGS84",
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters")

tinro2022_bongo_event_fnl <- tinro2022_bongo_event %>% 
  select(eventID, 
         station = Station, 
         eventDate, Year, Month, Day,
         decimalLatitude = Latitude,
         decimalLongitude = Longitude,
         minimumDepthInMeters,
         maximumDepthInMeters = `Wire out_m`,
         sampleSizeValue = `Vol filtered (m^3)`,
         fieldNotes = Notes,
         samplingEffort, sampleSizeUnit, geodeticDatum,
         eventRemarks = `D/N`)

tinro2022_bongo_event_fnl <- tinro2022_bongo_event_fnl %>%
  mutate(eventRemarks = case_when(
    eventRemarks == "D" ~ "Sampling event occurred during the day.",
    eventRemarks == "E" ~ "Sampling event occurred during the evening.",
    eventRemarks == "M" ~ "Sampling event occurred during the morning.",
    eventRemarks == "N" ~ "Sampling event occurred during the night."))

# For F/V Northwest Explorer:
nw2022_bongo_metadata <- nw2022_bongo_metadata %>% filter(Event_Type == "Bongo") %>%
  mutate(eventID = paste(Station_Event_ID, "1", sep = "-"),
         minimumDepthInMeters = 0,
         geodeticDatum = "WGS84",
         sampleSizeValue = 70.65,
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters",
         eventRemarks = "")

nw2022_bongo_metadata$Month <- as.numeric(nw2022_bongo_metadata$Month)
nw2022_bongo_metadata$Day <- as.numeric(nw2022_bongo_metadata$Day)

nw2022_bongo_metadata <- nw2022_bongo_metadata %>%
  mutate(Time_Start = as.POSIXct(Time_Start, format = "%H:%M:%S"),
         Time_End = as.POSIXct(Time_End, format = "%H:%M:%S")) %>%
  mutate(Time_Start = strftime(Time_Start, format = "%H:%M:%S"),
         Time_End = strftime(Time_End, format = "%H:%M:%S")) %>%
  mutate(eventDate_start = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_Start), tz ="UTC"))))

# For some tows, no Time_End was recorded. Therefore, for some eventDates, it will be a single recorded time, whereas for most it'll be a time span.
nw2022_bongo_metadata_1 <- nw2022_bongo_metadata %>%
  filter(is.na(Time_End)) %>%
  mutate(eventDate = paste0(eventDate_start, "Z"))

nw2022_bongo_metadata_2 <- nw2022_bongo_metadata %>%
  filter(!is.na(Time_End)) %>%
  mutate(eventDate_finish = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_End), tz = "UTC")), "Z"),
    eventDate = paste(eventDate_start, eventDate_finish, sep = "/"))

# Bind these rows again:
nw2022_bongo_metadata <- plyr::rbind.fill(nw2022_bongo_metadata_2, nw2022_bongo_metadata_1) 

nw2022_bongo_event_fnl  <- nw2022_bongo_metadata %>% 
  select(eventID, 
         station = Station, 
         eventDate, Year, Month, Day,
         decimalLatitude = Latitude_Start_DecDeg,
         decimalLongitude = Longitude_Start_DecDeg,
         minimumDepthInMeters,
         maximumDepthInMeters = Maximum_Sampling_Depth,
         sampleSizeValue,
         fieldNotes = Comments,
         samplingEffort, sampleSizeUnit, geodeticDatum,
         eventRemarks) 

# There was one bad tow that results in a duplicate eventID - remove this:
nw2022_bongo_event_fnl <- nw2022_bongo_event_fnl[!grepl("Bad tow", nw2022_bongo_event_fnl$fieldNotes),]

# For NOAA Bell M. Shimada:
shim2022_bongo_metadata <- shimada2022_bongo_metadata %>% filter(Event_Type == "Bongo") %>%
  mutate(eventID = paste(Station_Event_ID, "1", sep = "-"),
         minimumDepthInMeters = 0,
         geodeticDatum = "WGS84",
         sampleSizeValue = 70.65,
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters")

shim2022_bongo_metadata <- shim2022_bongo_metadata %>%
  mutate(Time_Start = as.POSIXct(Time_Start, format = "%H:%M:%S"),
         Time_End = as.POSIXct(Time_End, format = "%H:%M:%S")) %>%
  mutate(Time_Start = strftime(Time_Start, format = "%H:%M:%S"),
         Time_End = strftime(Time_End, format = "%H:%M:%S")) %>%
  mutate(eventDate_start = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_Start), tz ="UTC"))),
         eventDate_finish = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_End), tz = "UTC")), "Z"),
    eventDate = paste(eventDate_start, eventDate_finish, sep = "/"))

shim2022_bongo_event_fnl  <- shim2022_bongo_metadata %>% 
  select(eventID, 
         station = Station, 
         eventDate, Year, Month, Day,
         decimalLatitude = Latitude_Start_DecDeg,
         decimalLongitude = Longitude_Start_DecDeg,
         minimumDepthInMeters,
         maximumDepthInMeters = Maximum_Sampling_Depth_Meters,
         sampleSizeValue,
         fieldNotes = Comments,
         samplingEffort, sampleSizeUnit, geodeticDatum,
         eventRemarks = Day_Night) 

shim2022_bongo_event_fnl <- shim2022_bongo_event_fnl %>%
  mutate(eventRemarks = case_when(
    eventRemarks == "Day" ~ "Sampling event occurred during the day.",
    eventRemarks == "Night" ~ "Sampling event occurred during the night."))

# For the CCGS Sir John Franklin: 
franklin2022_bongo_meta <- franklin2022_bongo_meta %>% 
  select(`Station Name`, Year, Month, Day, `Local Time`, `UTC Offset`,
         decimalLatitude = `Latitude Degrees`, 
         decimalLongitude = `Longitude Degrees`,
         sampleSizeValue = `Volume Filtered (m3)`,
         minimumDepthInMeters = `Finish Depth`,
         maximumDepthInMeters = `Start Depth`,
         fieldNotes = `Flowmeter Flag`,
         eventRemarks = Notes) %>%
  mutate(samplingEffort = "volume seawater filtered", 
         sampleSizeUnit = "cubic meters",
         geodeticDatum = "WGS84",
         eventID = paste("IYS2022", "Franklin", 5, `Station Name`, "Bongo", "1", sep = "-"))

# Strip time
hrs <- abs(franklin2022_bongo_meta$`UTC Offset`) * 60 * 60
franklin2022_bongo_meta <- franklin2022_bongo_meta %>%
  mutate(Date = paste0(as_date(paste0(Year, "-", Month, "-", Day))),
         Time = as.POSIXct(`Local Time`, format = "%H:%M:%S"),
         Time = format(Time, "%H:%M:%S"),
         eventDate = as.POSIXct(paste0(Date, Time)),
         eventDate = eventDate + hrs,
         eventDate = paste0(format_ISO8601(eventDate), "Z"))

# Confirm that dates are still correct after standardizing to UTC.
dates <- franklin2022_bongo_meta %>% select(`Station Name`, Year, Month, Day, `Local Time`, `UTC Offset`, eventDate)

franklin2022_bongo_event_fnl <- franklin2022_bongo_meta %>%
  select(eventID, station = `Station Name`,
         eventDate, Year, Month, Day, decimalLatitude, decimalLongitude, minimumDepthInMeters,
         maximumDepthInMeters, sampleSizeValue, fieldNotes, samplingEffort, sampleSizeUnit,
         geodeticDatum, eventRemarks)

# Merge all the event tables from the vessels:
IYS2022_bongo_event <- rbind(tinro2022_bongo_event_fnl, nw2022_bongo_event_fnl, 
                             shim2022_bongo_event_fnl, franklin2022_bongo_event_fnl)

IYS2022_bongo_event <- IYS2022_bongo_event %>%
  mutate(footprintWKT = paste("POINT", " (", IYS2022_bongo_event$decimalLongitude, " ", IYS2022_bongo_event$decimalLatitude, ")"))

coordinates <- obistools::calculate_centroid(IYS2022_bongo_event$footprintWKT) %>% select(coordinateUncertaintyInMeters)

IYS2022_bongo_event <- cbind(IYS2022_bongo_event, coordinates)

# Remove NAs from the dataframe:
IYS2022_bongo_event[is.na(IYS2022_bongo_event)] <- ""
IYS2022_bongo_event <- as_tibble(IYS2022_bongo_event)

# Add language, modified and license columns:
IYS2022_bongo_event <- IYS2022_bongo_event %>%
  mutate(language = "en",
         modified = lubridate::today(),
         license = "https://creativecommons.org/licenses/by/4.0/legalcode",
         informationWithheld = "Contact data provider for information on abundance, sizes and biomass.",
         bibliographicCitation = "Breckenridge, J., Galbraith, M., King, J., Pinchuk, A., Stark, C., & Pakhomov, E. (2023). Bongo Zooplankton Data from the R/V TINRO, NOAA Bell M. Shimada, F/V Northwest Explorer and R/V CCGS Sir John Franklin during the 2022 International Year of the Salmon Pan-Pacific Winter High Seas Expedition (v1.0) [Data set]. North Pacific Anadromous Fish Commission. https://doi.org/10.21966/ymv6-8024",
         datasetID = "https://doi.org/10.21966/ymv6-8024")

# Save as .csv file
write_csv(IYS2022_bongo_event, here("standardized_data", "IYS2022_bongo_event.csv"))
```

## Section 2. Occurrence extension

Next, create the occurrence extensions. In the following section we develop an occurrence extension that will be nested under the Event Core. The occurrence extension will have unique occurrenceIDs that are associated with a specific observation of a taxa/lifestage/sex combination at a sampling station. These occurrenceIDs will therefore follow a similar format to the eventIDs and be nested under these IDs. The occurrenceIDs will have data on taxa (identified to the lowest rank practical), developmental stage and sex. The observed taxa are cross referenced to the WoRMS database. For this to happen, some ids have been modified slightly, however the original recording of the taxa has been preserved under _verbatimIdentification_. If any changes are made to the original recording as per the updated version from Joanne Breckenridge (UBC), the previous identification will remain recorded under _previousIdentifications_. 

```{r}
IYS2022_occ <- IYS2022_occ %>%
  select(Taxon, sex = Sex, 
         lifeStage = Dev_stage, 
         verbatimIdentification = original_id, 
         eventID, Abundance_m3, Abundance_m2) %>%
  filter(Abundance_m3 != 0.00000)

IYS2022_occ$sex[IYS2022_occ$sex == "F"] <- "Female"
IYS2022_occ$sex[IYS2022_occ$sex == "M"] <- "Male"

# Add additional columns required or highly recommended for Darwin Core:
IYS2022_occ <- IYS2022_occ %>%
  mutate(basisOfRecord = "HumanObservation",
         occurrenceStatus = "present",
         preparations = "formalin",
         occurrenceID = paste(eventID, row_number(), sep = "-"),
         identificationRemarks = NA)

IYS2022_occ$verbatimIdentification <- tolower(IYS2022_occ$verbatimIdentification)
IYS2022_occ$verbatimIdentification <- Hmisc::capitalize(IYS2022_occ$verbatimIdentification)
IYS2022_occ$scientific_name <- IYS2022_occ$verbatimIdentification

# Remove lifestages, sizes and identificationQualifier from scientific_name
IYS2022_occ$scientific_name <- gsub(" larvae| juveniles| juv| furcilia| bracts| nurse| medium| small| extra small| nauplii| zoea| calyptopis| am| aff| af| v$| iv| iii| ii| i$", "", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("\\(old\\)|\\(small\\)|\\(medium\\)|\\(extra\\)", "", IYS2022_occ$scientific_name)

IYS2022_occ <- IYS2022_occ %>%
  mutate(identificationQualifier = ifelse(grepl("\\b sp.\\b|\\b spp.\\b|\\b sp. \\b", IYS2022_occ$scientific_name), "sp. indet.", NA),
         identificationQualifier = ifelse(grepl(" aff", IYS2022_occ$scientific_name), "sp. aff.", identificationQualifier),
         identificationQualifier = ifelse(grepl("Neocalanus plumchrus/flemingeri|Neocalanus flemingeri/plumchrus", IYS2022_occ$scientific_name), "sp. indet.", identificationQualifier))

IYS2022_occ <- IYS2022_occ %>%
  mutate(identificationRemarks = ifelse(grepl("Limacina helicina acuta", verbatimIdentification), 
                                        "Morphotype: acuta", identificationRemarks))

IYS2022_occ <- IYS2022_occ %>%
  mutate(lifeStage = ifelse(grepl("trich", scientific_name), "trochophore", IYS2022_occ$lifeStage))
IYS2022_occ$lifeStage[IYS2022_occ$verbatimIdentification == "Siphonophore bract"] <- "polygastric"
IYS2022_occ$lifeStage[IYS2022_occ$verbatimIdentification == "Siphonophora bracts"] <- "polygastric"

# Size (ranges) in the scientific_name should be removed
IYS2022_occ$scientific_name <-  gsub("0.5mm", "", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <-  gsub("1.5mm", "", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <-  gsub("2.5mm", "", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <-  gsub("1mm", "", IYS2022_occ$scientific_name) 

IYS2022_occ$scientific_name <- trimws(IYS2022_occ$scientific_name, "r")

IYS2022_occ$scientific_name <- gsub("\\b sp.\\b|\\b spp.\\b", "", IYS2022_occ$scientific_name)

# Some changes to taxa observations as per Joanne Breckenridge. Previous identifications will remain available in the column `previousIdentifications`:
IYS2022_occ <- IYS2022_occ %>%
  mutate(previousIdentifications = dplyr::case_when(
    IYS2022_occ$verbatimIdentification == "Euchaeta elongata" ~ "Euchaeta elongata",
    IYS2022_occ$verbatimIdentification == "Euphausiacea nauplii" ~ "Euphausiacea nauplii",
    IYS2022_occ$verbatimIdentification == "Euphausiacea calyptopis" ~ "Euphausiacea calyptopis",
    IYS2022_occ$verbatimIdentification == "Euphausiacea" ~ "Euphausiacea",
    IYS2022_occ$verbatimIdentification == "Euphausiacea spp." ~ "Euphausiacea spp.",
    IYS2022_occ$verbatimIdentification == "Euphausiacea furcilia" ~ "Euphausiacea furcilia",
    IYS2022_occ$verbatimIdentification == "Nematoscelis sp. juveniles" ~ "Nematoscelis sp. juveniles",
    IYS2022_occ$verbatimIdentification == "Scolecithricella ovata" ~ "Scolecithricella ovata",
    IYS2022_occ$verbatimIdentification == "Nemertina" ~ "Nemertina",
    IYS2022_occ$verbatimIdentification == "Sagitta elegans" ~ "Sagitta elegans",
    IYS2022_occ$verbatimIdentification == "Primno macropa" ~ "Primno macropa",
    IYS2022_occ$verbatimIdentification == "Parathemisto pacifica" ~ "Parathemisto pacifica",
    IYS2022_occ$verbatimIdentification == "Sagitta scrippae" ~ "Sagitta scrippae",
    IYS2022_occ$verbatimIdentification == "Pseudosagitta scrippsae" ~ "Pseudosagitta scrippsae",
    IYS2022_occ$verbatimIdentification == "Scaphocalanus brevicornis" ~ "Scaphocalanus brevicornis"))

IYS2022_occ$verbatimIdentification[IYS2022_occ$verbatimIdentification == 'Euchaeta elongata' ] <- 'Paraeuchaeta elongata'
IYS2022_occ$verbatimIdentification[IYS2022_occ$verbatimIdentification == "Euphausiacea nauplii" | IYS2022_occ$verbatimIdentification == "Euphausiacea calyptopis" | IYS2022_occ$verbatimIdentification == "Euphausiacea" | IYS2022_occ$verbatimIdentification == "Euphausiacea spp." | IYS2022_occ$verbatimIdentification == "Euphausiacea furcilia" ] <- 'Euphausiidae'
IYS2022_occ$verbatimIdentification[IYS2022_occ$verbatimIdentification == "Nematoscelis sp. juveniles" ] <- 'Nematoscelis difficilis' #After consult with Moira, only one species in region
IYS2022_occ$verbatimIdentification[IYS2022_occ$verbatimIdentification == "Scolecithricella ovata" ] <- "Pseudoamallothrix ovata"
IYS2022_occ$verbatimIdentification[IYS2022_occ$verbatimIdentification == "Nemertina" ] <- "Nemertea"
IYS2022_occ$verbatimIdentification[IYS2022_occ$verbatimIdentification == "Sagitta elegans" ] <- "Parasagitta elegans"
IYS2022_occ$verbatimIdentification[IYS2022_occ$verbatimIdentification == "Primno macropa" ] <- "Primno abyssalis"
IYS2022_occ$verbatimIdentification[IYS2022_occ$verbatimIdentification == "Parathemisto pacifica" ] <- "Themisto pacifica"
IYS2022_occ$verbatimIdentification[IYS2022_occ$verbatimIdentification == "Pseudosagitta scrippsae" | IYS2022_occ$verbatimIdentification == "Sagitta scrippae" ] <- "Pseudosagitta lyra"
IYS2022_occ$verbatimIdentification[IYS2022_occ$verbatimIdentification == "Scaphocalanus brevicornis" ] <- "Spinocalanus brevicaudatus"

# Add lifestage for Crytoniscid and Microniscid:
IYS2022_occ <- IYS2022_occ %>%
  mutate(lifeStage = ifelse(IYS2022_occ$verbatimIdentification == "Crytoniscid", "crytoniscid larva", lifeStage),
         lifeStage = ifelse(IYS2022_occ$verbatimIdentification == "Microniscid", "microniscid larva", lifeStage))

# Match to WoRMS:
unique_spp <- IYS2022_occ %>% select(scientific_name) %>% unique() %>% as.data.frame()
worms_1 <- worrms::wm_records_names(unique_spp$scientific_name[1:115], marine_only = F) %>% dplyr::bind_rows() %>% rename(scientific_name = scientificname)
worms_2 <- worrms::wm_records_names(unique_spp$scientific_name[116:230], marine_only = F) %>% dplyr::bind_rows() %>% rename(scientific_name = scientificname)
worms <- rbind(worms_1, worms_2)

# Find out which species are not found in the WoRMS database:
no_worms_id <- left_join(IYS2022_occ, worms, by = "scientific_name") %>% filter(is.na(AphiaID)) %>% distinct(scientific_name)

# Make changes manually as needed to 29 identified taxa:
IYS2022_occ$scientific_name <- gsub("Siphonophora", "Siphonophorae", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Siphonophore bract", "Siphonophorae", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Conchoecia rudjakovi", "Conchoecia rudyakovi", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Conchoecinae", "Conchoeciinae", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Oikopleura labradoriensis", "Oikopleura (Vexillaria) labradoriensis", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Limacina helicina acuta", "Limacina helicina", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("\\bEpicarid\\b", "Epicaridea", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("\\bDoliolid\\b", "Doliolidae", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Fish", "Pisces", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Oikopleura longicauda", "Oikopleura (Coecaria) longicauda", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Neocalanus plumchrus/flemingeri", "Neocalanus", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Neocalanus flemingeri/plumchrus", "Neocalanus", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Thysanoesa inspinata", "Thysanoessa inspinata", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Thysanoesa spinifer", "Thysanoessa spinifera", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Thysanoesa inermis", "Thysanoessa inermis", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Thysanoesa longipes", "Thysanoessa longipes", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Chionocetes", "Chionoecetes", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Crytoniscid", "Isopoda", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Microniscid", "Isopoda", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Polycheata", "Polychaeta", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Tyroscrolex maybe", "Animalia", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Squid", "Teuthida", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Eukronia hamata", "Eukrohnia hamata", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Mesocalanus teniucornus", "Mesocalanus tenuicornis", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Acartia longirmis", "Acartia longiremis", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Sagitta scrippae", "Sagitta scrippsae", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Gastropoda. trich", "Gastropoda", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Gastropoda \\(echinospira\\)", "Echinospira", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Oithona sp. copepodids", "Oithona", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Metridia ochotensis", "Metridia okhotensis", IYS2022_occ$scientific_name)
IYS2022_occ$scientific_name <- gsub("Gaetanus intermedius", "Gaetanus simplex", IYS2022_occ$scientific_name) # As per A. Pinchuk

# Make sure changes are reflected:
unique_spp <- IYS2022_occ %>% select(scientific_name) %>% unique() %>% as.data.frame()
updated_worms_id_1 <- worrms::wm_records_names(unique_spp$scientific_name[1:115], marine_only = FALSE) %>% dplyr::bind_rows() %>% rename(scientific_name = scientificname)
updated_worms_id_2 <- worrms::wm_records_names(unique_spp$scientific_name[116:230], marine_only = FALSE) %>% dplyr::bind_rows() %>% rename(scientific_name = scientificname)
updated_worms_id <- rbind(updated_worms_id_1, updated_worms_id_2)

# The following should be an empty data table:
no_worms_id <- left_join(IYS2022_occ, updated_worms_id, by = "scientific_name") %>% filter(is.na(AphiaID)) %>% distinct(scientific_name)

# Remove AphiaIDs that are incorrect.
IYS2022_occ_worms <- filter(updated_worms_id, !(AphiaID %in% c("603038", "254409", "410743", "14775", "588510", "835292", "534090", "999078", "503291", "426434"))) %>%
  select(scientific_name,
         scientificNameID = lsid,
         scientificNameAuthorship = authority,
         taxonomicStatus = status,
         taxonRank = rank,
         kingdom, phylum, class, order, family, genus, AphiaID)

IYS2022_occ_final <- left_join(IYS2022_occ, IYS2022_occ_worms, by = "scientific_name") %>%
  rename(scientificName = scientific_name) %>%
  mutate(specificEpithet = stringr::word(scientificName, 2),
         specificEpithet = ifelse(scientificName == "Oikopleura (Vexillaria) labradoriensis", "labradoriensis", specificEpithet),
         specificEpithet = ifelse(scientificName == "Oikopleura (Coecaria) longicauda", "longicauda", specificEpithet)) %>%
  mutate(identificationRemarks = ifelse(identificationQualifier == "sp. aff.", 
                                        "Taxa documented is the closest affiliation to taxa observed, but not the taxa observed.",
                                        identificationRemarks),
         identificationRemarks = ifelse(identificationQualifier == "sp. indet.", 
                                        "Taxa is within this taxonomic rank but cannot be identified further due to life stage, missing body parts or due to the destructive nature of the sampling, preservation and analysis process.", 
                                        identificationRemarks),
         identificationRemarks = ifelse(verbatimIdentification == "Tyroscrolex maybe", 
                                        "Tyroscrolex maybe",
                                        identificationRemarks),
         identificationRemarks = ifelse(grepl("Limacina helicina acuta", verbatimIdentification),
                                        "Morphotype: acuta",
                                        identificationRemarks),
         identificationRemarks = ifelse(grepl("Neocalanus plumchrus/flemingeri|Neocalanus flemingeri/plumchrus", IYS2022_occ$scientific_name), 
                                        "Taxa is within this taxonomic rank and likely either N. flemingeri or N. plumchrus, but cannot be identified further due to life stage, missing body parts or due to the destructive nature of the sampling, preservation and analysis process.", identificationRemarks))

# Remove brackets from the scientificNameAuthorship, then join it to the scientificName following format:
# <scientificName> (scientificNameAuthorship)
IYS2022_bongo_occ <- IYS2022_occ_final %>%
  mutate(scientificNameAuthorship = str_replace_all(scientificNameAuthorship, "\\(|\\)", ""),
         scientificNameAuthorship = ifelse(scientificNameAuthorship == "", NA, scientificNameAuthorship)) %>%
  mutate(scientificName = ifelse(!is.na(scientificNameAuthorship), 
                                 paste0(scientificName, " (", scientificNameAuthorship, ")"),
                                 scientificName)) %>%
  select(-Taxon, -Abundance_m3, -Abundance_m2, -AphiaID)

IYS2022_bongo_occ[is.na(IYS2022_bongo_occ)] <- ""
write_csv(IYS2022_bongo_occ, here("standardized_data", "IYS2022_bongo_occ.csv"))
```

## Section 3. extended measurement Or Fact (eMOF) extension

The eMOF data table will be specific to information that can be nested under the occurrenceID. It provides further information on taxa abundance, as well as controlled vocabulary for associated sex and developmental stages. 

```{r emof cont., eval = FALSE}
bongo2022_emof <- IYS2022_occ_final %>%
  select(occurrenceID, sex, lifeStage, Abundance_m3, Abundance_m2) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = sex:Abundance_m3,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementID = paste(occurrenceID, measurementType, sep = "-"),
    measurementTypeID = case_when(
      measurementType == "lifeStage" ~ "http://vocab.nerc.ac.uk/collection/P01/current/LSTAGE01/",
      measurementType == "sex" ~ "http://vocab.nerc.ac.uk/collection/P01/current/ENTSEX01/",
      measurementType == "Abundance_m3" ~ "http://vocab.nerc.ac.uk/collection/P01/current/SDBIOL01/",
      measurementType == "Abundance_m2" ~ "http://vocab.nerc.ac.uk/collection/P01/current/SDBIOL02/"),
    measurementUnit = case_when(
      measurementType == "Abundance_m3" ~ "individuals per cubic meter",
      measurementType == "Abundance_m2" ~ "individuals per square meter"), 
    measurementUnitID = case_when(
      measurementUnit == "individuals per cubic meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UPMM/",
      measurementUnit == "individuals per square meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UPMS/"),
    measurementValueID = case_when(
      measurementValue == "Male" ~ "http://vocab.nerc.ac.uk/collection/S10/current/S103/",
      measurementValue == "Female" ~ "http://vocab.nerc.ac.uk/collection/S10/current/S102/",
      measurementValue == "adult" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1116/",
      measurementValue == "C5" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1112/",
      measurementValue == "C6" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1110/",
      measurementValue == "C4-5" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1111/",
      measurementValue == "C4" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1110/",
      measurementValue == "C3" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S118/",
      measurementValue == "C2" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S117/",
      measurementValue == "C1" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S111/",
      measurementValue == "juvenile" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1127/",
      measurementValue == "furcilia" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1123/",
      measurementValue == "egg" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1122/",
      measurementValue == "nauplii" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1130/",
      measurementValue == "cal" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1118/",
      measurementValue == "larvae" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1128/",
      measurementValue == "Megalopa" ~ "https://vocab.nerc.ac.uk/collection/S11/current/S1167/",
      measurementValue == "preflexion" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1188/", 
      measurementValue == "calyptopis" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1118/",
      measurementValue == "nectophore" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1197/",
      measurementValue == "old nurse" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1196/",
      measurementValue == "flexion" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1189/",
      measurementValue == "nauplius" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1130/",
      measurementValue == "mysis" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1161/",
      measurementValue == "polytroch" ~ " ",
      measurementValue == "eudoxid" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1195/",
      measurementValue == "postflexion" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1190/",
      measurementValue == "veliger" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1193/",
      measurementValue == "trochophore" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1192/",
      measurementValue == "C5-6" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1114/",
      measurementValue == "gas floats" ~ " ",
      measurementValue == "megalopa" ~ "https://vocab.nerc.ac.uk/collection/S11/current/S1167/",
      measurementValue == "cyprid" ~ " ",
      measurementValue == "C4/C5" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1111/",
      measurementValue == "zoea" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1137/", 
      measurementValue == "polygastric" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1101/",
      measurementValue == "nurse" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1196/",
      measurementValue == "zooid" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1138/",
      measurementValue == "crytoniscid larva" ~ " ",
      measurementValue == "cyphonautes" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1119/",
      measurementValue == "microniscid larva" ~ " "),
    measurementRemarks = NA) %>%
  drop_na(measurementValue)

# Save locally
write_csv(bongo2022_emof, here("standardized_data", "IYS2022_bongo_emof.csv"))
```

## Section 4. Basic QAQC

Run some basic QAQC tests to ensure compatibility with other data in OBIS:

```{r checks, eval = FALSE}

IYS2022_bongo_event$decimalLatitude <- as.numeric(IYS2022_bongo_event$decimalLatitude)
IYS2022_bongo_event$decimalLongitude <- as.numeric(IYS2022_bongo_event$decimalLongitude)
bongo2022_leaflet <- obistools::plot_map_leaflet(IYS2022_bongo_event)
bongo_map <- obistools::plot_map(IYS2022_bongo_event, zoom = TRUE)
ggsave(filename = "bongo2022_map.png", plot = bongo_map,
       path = here::here("standardized_data", "maps"))

# Check if all OBIS required fields are present in occurrence table:
obistools::check_fields(IYS2022_occ_final) # Only missing eventDate, decimalLongitude and decimalLatitude which are in the event table.

# Check whether all eventIDs are matched:
obistools::check_extension_eventids(IYS2022_bongo_event, IYS2022_bongo_final)

# Check eventDate
obistools::check_eventdate(IYS2022_bongo_event)

# Create tree structure -- not very exciting for this data structure
tree <- treeStructure(IYS2022_bongo_event, IYS2022_bongo_final)
exportTree(tree, "tree.html")

```

## Section 5. Standardizing zooplankton data to the IYS Data Template

We want to standardize the data as well for the IYS Data Template, to allow integration into the Integrated Data Collection. To this end, we'll have to include the metadata in the _Sampling Events_ sheet, and specimen data in _Bongo Specimen Data_. To put it in that format, combine the Event Core and occurrence extension and select and rename the correct columns. **Please note: To facilitate comparison across vessels, we will likely end up using the standardized data tables as provided by Joanne Breckenridge for Version 5 of the Integrated Data Collection. As such, this chunk of code will likely move to a separate repository that will include standardized zooplankton data from 2019, 2020 and 2022**. 

```{r IYS Template, eval = FALSE}
bongo2022_sampling_event <- IYS2022_bongo_event %>%
   mutate(cruise_name = "IYS2022",
          dataset_doi = "https://doi.org/10.21966/ymv6-8024",
         vessel_name_abbr = case_when(
           grepl("Franklin", IYS2022_bongo_event$eventID) ~ "Franklin",
           grepl("TINRO", IYS2022_bongo_event$eventID) ~ "TINRO",
           grepl("NW", IYS2022_bongo_event$eventID) ~ "NW",
           grepl("Shimada", IYS2022_bongo_event$eventID) ~ "Shimada"),
         zone = case_when(
           vessel_name_abbr == "Franklin" ~ 5,
           vessel_name_abbr == "TINRO" ~ 3,
           vessel_name_abbr == "NW" ~ 2,
           vessel_name_abbr == "Shimada" ~ 4),
         station,
         event_type = "Bongo",
         time_zone_code = "UTC",
         event_date = as.Date(paste(Year,Month,Day, sep = "-")),
         time_start = gsub("/.*$", "", eventDate),
         time_start = lubridate::ymd_hms(time_start),
         time_start = format(time_start, format = "%H:%M:%S"),
         time_end = gsub(".*/", "", eventDate),
         time_end = lubridate::ymd_hms(time_end),
         time_end = format(time_end, format = "%H:%M:%S"),
         day_night = case_when(
           grepl("day", IYS2022_bongo_event$eventRemarks) ~ "Day",
           grepl("night", IYS2022_bongo_event$eventRemarks) ~ "Night"),
         day_of_year = lubridate::yday(event_date))

# Create some dummy columns:
bongo2022_sampling_event <- bongo2022_sampling_event %>%
  mutate(alternative_event_id = "",
         tow_speed_kilometers_per_hour = "",
         latitude_end_decdeg = "",
         longitude_end_decdeg = "",
         bottom_depth_meters = "",
         wind_direction_degrees = "",
         wind_speed_kilometers_per_hour = "",
         wave_height_meters = "",
         swell_height_meters = "",
         weather_description = "",
         comments = "")

#TODO: Code chunk below is horrible and needs fixing.
bongo2022_sampling_event <- bongo2022_sampling_event %>%
  mutate(time_end = ifelse(time_end == time_start, NA, time_end),
         sampling_duration_minutes = with(bongo2022_sampling_event, 
                                          difftime(as.POSIXct(bongo2022_sampling_event$time_start, format = "%H:%M:%S"), 
                                                   as.POSIXct(bongo2022_sampling_event$time_end, format = "%H:%M:%S"), 
                                                   units = "mins")),
         sampling_duration_minutes = round(sampling_duration_minutes, digits = 0),
         sampling_duration_minutes = sampling_duration_minutes*-1,
         sampling_duration_minutes = as.numeric(sampling_duration_minutes))

bongo2022_sampling_event <- bongo2022_sampling_event %>%
    select(cruise_name, vessel_name_abbr, zone, station, event_type, station_event_id = eventID, 
           alternative_event_id, event_date, 
           year = Year,
           month = Month,
           day = Day,
           time_start, time_end, sampling_duration_minutes, day_night, time_zone_code, 
           minimum_sampling_depth_meters = minimumDepthInMeters,
           maximum_sampling_depth_meters = maximumDepthInMeters,
           tow_speed_kilometers_per_hour,
           latitude_start_decdeg = decimalLatitude,
           longitude_start_decdeg = decimalLongitude,
           latitude_end_decdeg, longitude_end_decdeg, bottom_depth_meters, wind_direction_degrees,
           wind_speed_kilometers_per_hour,
           wave_height_meters, swell_height_meters, weather_description, comments, day_of_year, dataset_doi)

col_order <- c("cruise_name", "vessel_name_abbr", "zone", "station", "event_type", "station_event_id",
               "alternative_event_id", "event_date", "year", "month", "day", "time_start", "time_end",
               "sampling_duration_minutes", "day_night", "time_zone_code","minimum_sampling_depth_meters",
               "maximum_sampling_depth_meters", "tow_speed_kilometers_per_hour", "latitude_start_decdeg",
               "longitude_start_decdeg", "latitude_end_decdeg", "longitude_end_decdeg", "bottom_depth_meters",
               "wind_direction_degrees", "wind_speed_kilometers_per_hour", "wave_height_meters", 
               "swell_height_meters", "weather_description", "comments", "day_of_year", "dataset_doi")
bongo2022_sampling_event <- bongo2022_sampling_event[, col_order]

# Save locally:
write_csv(bongo2022_sampling_event, here("IYS_data_template", "Bongo_Sampling_Event.csv"))

# Create Bongo Specimen Data:
bongo2022_template <- left_join(IYS2022_bongo_event, IYS2022_bongo_final, by = "eventID") %>%
  select(station_event_id = eventID,
         catch_id = occurrenceID,
         scientific_name = scientificName,
         verbatimIdentification,
         taxonomic_rank = taxonomicRank,
         lifestage = lifeStage,
         sex,
         size_range,
         preservation_method = preparations,
         catch_count = individualCount,
         abundance_m3 = organismQuantity,
         flowmeter_volume_filtered_m3 = sampleSizeValue) %>%
  mutate(net_number = 1,
         prop_total_sample = "",
         sf_proc = "",
         common_name = "",
         identified_by = "",
         date_identified = "",
         count_method = "Total", #TODO: confirm this
         depth_volume_filtered_m3 = "",
         comments = "") #TODO: this could be 'eventRemarks'

# Drop rows where abundance_m3 is 0
bongo2022_template <- bongo2022_template %>% filter(!abundance_m3 == 0)

# Compared to the 2019 and 2020 data, we should still include information on the proportion of the sample processed when doing taxonomy for each size fraction (prop_sf_proc). This information is included in the zoop data_raw counts sheet:

sf <- read_excel(here("original_data", "7-14 2022 Bongo Logbook-TINRO_clean.xlsx"), sheet = "zoop data_raw counts")
sf <- sf[-c(1:6),]

# Select species column
sf_species <- sf[, 1]
colnames(sf_species)[1] <- "verbatimIdentification"

# Select only the columns where `total counted per split` is NA, as these columns depict 1) the lifestage (col #1) and 2) the proportion size fractionated:
col_odd <- seq_len(ncol(sf)) %% 2
sf <- sf[ , col_odd == 0]

# Combine species column with columns associated with the proportion size fractionated:
new_sf <- cbind(sf_species, sf)

# Change column headers, and adjust class where necessary:
new_sf <- setNames(new_sf, c("verbatimIdentification", "Stage/length", "1", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12",
                             "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32"))

new_sf$`1` <- as.numeric(new_sf$`1`)

# pivot long:
new_sf <- new_sf %>%
  pivot_longer(cols = 3:33,
               values_to = "prop_sf_proc",
               names_to = "station") %>%
  mutate(station_event_id = paste("IYS2022", "TINRO", "3", station, "Bongo", "1", sep = "-")) %>%
  drop_na(prop_sf_proc)

# Parse out `Stage/length` column into two separate columns. We have to do this to properly match prop_sf_proc to the correct species/sex/lifestage combination.
new_sf <- new_sf %>%
  mutate(size_range = ifelse(grepl("\\d+", `Stage/length`), `Stage/length`, NA), 
         `Stage/length` = ifelse(grepl("\\d+", `Stage/length`), NA, `Stage/length`), 
         sex = ifelse(grepl("F", `Stage/length`), "female", 
                      ifelse(grepl("M", `Stage/length`), "male", NA)), 
         `Stage/length` = ifelse(grepl("A", `Stage/length`), "Adult", `Stage/length`)) %>% 
  rename(lifestage = `Stage/length`) %>%
  select(verbatimIdentification, lifestage, prop_sf_proc, station_event_id, sex, size_range) %>%
  distinct()

# Lifestages in the verbatimidentification should also be included in the lifeStage column:
new_sf <- new_sf %>%
  mutate(lifestage = ifelse(grepl("larvae", verbatimIdentification), "larvae", lifestage),
         lifestage = ifelse(grepl("juv.", verbatimIdentification), "juvenile", lifestage),
         lifestage = ifelse(grepl("egg", verbatimIdentification), "egg", lifestage))

# Remove NAs from the dataframe:
new_sf[is.na(new_sf)] <- ""
new_sf <- as.data.frame(new_sf)

# Integrate within the IYS Data Template:
bongo2022_template <- left_join(bongo2022_template, new_sf, 
                                by = c("verbatimIdentification", "station_event_id", "lifestage", "sex", "size_range"))

col_order <- c("station_event_id", "net_number", "catch_id", "scientific_name", "verbatimIdentification",
               "taxonomic_rank",
               "prop_total_sample", "sf_proc", "prop_sf_proc", "lifestage", "sex", "common_name", "identified_by",
               "date_identified", "preservation_method", "catch_count", "size_range", "count_method", "abundance_m3",
               "flowmeter_volume_filtered_m3", "depth_volume_filtered_m3", "comments")
bongo2022_template <- bongo2022_template[, col_order]

bongo2022_template[is.na(bongo2022_template)] <- ""
bongo2022_template <- as.data.frame(bongo2022_template)

# Save locally:
write_csv(bongo2022_template, here("IYS_data_template", "Bongo_Specimen_Data.csv"))
```

Read these two data tables into a single IYS Zooplankton Template workbook:

```{r}
library(xlsx)
write.xlsx(bongo2022_sampling_event, file="IYS2022_Zooplankton_Template.xlsx", sheetName="Sampling_Events", row.names=FALSE)
write.xlsx(bongo2022_template, file="IYS2022_Zooplankton_Template.xlsx", sheetName="Bongo_Specimen_Data", append=TRUE,
           row.names=FALSE)
```










