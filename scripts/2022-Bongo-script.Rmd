---
title: "2022-IYS-Bongo"
author: "Tim van der Stap"
date: "2022-09-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
library(tidyverse)
library(lubridate)
library(worrms)
library(dplyr)
library(obistools)
library(readxl)
library(parsedate)
library(googledrive)
library(here)
library(Hmisc)
```

Download the latest Data Template for the Shimada and NW Explorer to get the metadata associated with the Bongo tows:

```{r download, eval = FALSE}
download.file("https://github.com/international-year-of-the-salmon/2022-shimada-data-template/blob/main/IYS2022_Shimada_Data_template.xlsx?raw=true", here::here("IYS_data_template", "IYS2022_Shimada_data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-NW-Data-Template/blob/main/IYS2022_NW_Data.xlsx?raw=true", here::here("IYS_data_template", "IYS2022_NW_Data.xlsx"), quiet = TRUE, mode = "wb")
```

## Read in files:

``` {r read_file, warning = FALSE}
tinro2022_bongo_metadata <- read_excel(here("original_data", "7-14 2022 Bongo Logbook-TINRO_clean.xlsx"), sheet = "Bongo metadata")
shimada2022_bongo_metadata <- read_excel(here("IYS_data_template", "IYS2022_Shimada_data.xlsx"), sheet = "4. SAMPLING EVENT INFO")
nw2022_bongo_metadata <- read_excel(here("IYS_data_template", "IYS2022_NW_Data.xlsx"), sheet = "Sampling_Event_Info")
franklin2022_bongo_meta <- read_excel(here("original_data", "2022002 IYS Franklin abund biomass by species n life stage .xlsx"), sheet = "metadata")


tinro2022_bongo_data <- read_excel(here("original_data", "7-14 2022 Bongo Logbook-TINRO_clean.xlsx"), sheet = "zoop counts")
nw2022_bongo_data <- read_excel(here("IYS_data_template", "IYS2022_Shimada_NW_Zooplankton.xlsx"), sheet = "NWExplorer-Bongo-Taxonomy")
shim2022_bongo_data <- read_excel(here("IYS_data_template", "IYS2022_Shimada_NW_Zooplankton.xlsx"), sheet = "Shimada-Bongo-Taxonomy")
franklin2022_bongo_data <- read_excel(here("original_data", "2022002 IYS Franklin abund biomass by species n life stage .xlsx"), sheet = "abund biomass")
```

Standardize the metadata into Darwin Core and create the Event Core from the TINRO, NW Explorer, Shimada and Franklin metadata:

``` {r event core, eval = FALSE}
tinro2022_bongo_event <- tinro2022_bongo_metadata %>%
  select(-`T, surf`) %>%
  mutate(Time = format(`Time, UTC`, "%H:%M:%S"),
         eventDate = format_iso_8601(as.POSIXct(paste(Date, Time),
                                                format = "%Y-%m-%d %H:%M:%S",
                                                tz = "UTC")),
         eventDate = str_replace(eventDate, "\\+00:00", "Z"))

tinro2022_bongo_event$Year <- as.numeric(format(as.Date(tinro2022_bongo_event$eventDate), "%Y"))
tinro2022_bongo_event$Month <- as.numeric(format(as.Date(tinro2022_bongo_event$eventDate), "%m"))
tinro2022_bongo_event$Day <- as.numeric(format(as.Date(tinro2022_bongo_event$eventDate), "%d"))

tinro2022_bongo_event <- tinro2022_bongo_event %>%
  mutate(zone = 3,
         eventID = paste("IYS2022", "TINRO", zone, Station, Gear, `Net number`, sep = "-"),
         minimumDepthInMeters = 0,
         geodeticDatum = "WGS84",
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters")

tinro2022_bongo_event_fnl <- tinro2022_bongo_event %>% 
  select(eventID, 
         station = Station, 
         eventDate, Year, Month, Day,
         decimalLatitude = Latitude,
         decimalLongitude = Longitude,
         minimumDepthInMeters,
         maximumDepthInMeters = `Wire out_m`,
         sampleSizeValue = `Vol filtered (m^3)`,
         fieldNotes = Notes,
         samplingEffort, sampleSizeUnit, geodeticDatum,
         eventRemarks = `D/N`)

tinro2022_bongo_event_fnl <- tinro2022_bongo_event_fnl %>%
  mutate(eventRemarks = case_when(
    eventRemarks == "D" ~ "Sampling event occurred during the day.",
    eventRemarks == "E" ~ "Sampling event occurred during the evening.",
    eventRemarks == "M" ~ "Sampling event occurred during the morning.",
    eventRemarks == "N" ~ "Sampling event occurred during the night."))

# For F/V Northwest Explorer:
nw2022_bongo_metadata <- nw2022_bongo_metadata %>% filter(Event_Type == "Bongo") %>%
  mutate(eventID = paste(Station_Event_ID, "1", sep = "-"),
         minimumDepthInMeters = 0,
         geodeticDatum = "WGS84",
         sampleSizeValue = 70.65,
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters",
         eventRemarks = "")

nw2022_bongo_metadata <- nw2022_bongo_metadata %>%
  mutate(Time_Start = as.POSIXct(Time_Start, format = "%H:%M:%S"),
         Time_End = as.POSIXct(Time_End, format = "%H:%M:%S")) %>%
  mutate(Time_Start = strftime(Time_Start, format = "%H:%M:%S"),
         Time_End = strftime(Time_End, format = "%H:%M:%S")) %>%
  mutate(eventDate_start = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_Start), tz ="UTC"))))

# For some tows, no Time_End was recorded. Therefore, for some eventDates, it will be a single recorded time, whereas for most it'll be a time span.
nw2022_bongo_metadata_1 <- nw2022_bongo_metadata %>%
  filter(is.na(Time_End)) %>%
  mutate(eventDate = paste0(eventDate_start, "Z"))

nw2022_bongo_metadata_2 <- nw2022_bongo_metadata %>%
  filter(!is.na(Time_End)) %>%
  mutate(eventDate_finish = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_End), tz = "UTC")), "Z"),
    eventDate = paste(eventDate_start, eventDate_finish, sep = "/"))

# Bind these rows again:
nw2022_bongo_metadata <- plyr::rbind.fill(nw2022_bongo_metadata_2, nw2022_bongo_metadata_1) 

nw2022_bongo_event_fnl  <- nw2022_bongo_metadata %>% 
  select(eventID, 
         station = Station, 
         eventDate, Year, Month, Day,
         decimalLatitude = Latitude_Start_DecDeg,
         decimalLongitude = Longitude_Start_DecDeg,
         minimumDepthInMeters,
         maximumDepthInMeters = Maximum_Sampling_Depth,
         sampleSizeValue,
         fieldNotes = Comments,
         samplingEffort, sampleSizeUnit, geodeticDatum,
         eventRemarks) 

# For NOAA Bell M. Shimada:
shim2022_bongo_metadata <- shimada2022_bongo_metadata %>% filter(Event_Type == "Bongo") %>%
  mutate(eventID = paste(Station_Event_ID, "1", sep = "-"),
         minimumDepthInMeters = 0,
         geodeticDatum = "WGS84",
         sampleSizeValue = 70.65,
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters")

shim2022_bongo_metadata <- shim2022_bongo_metadata %>%
  mutate(Time_Start = as.POSIXct(Time_Start, format = "%H:%M:%S"),
         Time_End = as.POSIXct(Time_End, format = "%H:%M:%S")) %>%
  mutate(Time_Start = strftime(Time_Start, format = "%H:%M:%S"),
         Time_End = strftime(Time_End, format = "%H:%M:%S")) %>%
  mutate(eventDate_start = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_Start), tz ="UTC"))),
         eventDate_finish = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_End), tz = "UTC")), "Z"),
    eventDate = paste(eventDate_start, eventDate_finish, sep = "/"))

shim2022_bongo_event_fnl  <- shim2022_bongo_metadata %>% 
  select(eventID, 
         station = Station, 
         eventDate, Year, Month, Day,
         decimalLatitude = Latitude_Start_DecDeg,
         decimalLongitude = Longitude_Start_DecDeg,
         minimumDepthInMeters,
         maximumDepthInMeters = Maximum_Sampling_Depth_Meters,
         sampleSizeValue,
         fieldNotes = Comments,
         samplingEffort, sampleSizeUnit, geodeticDatum,
         eventRemarks = Day_Night) 

shim2022_bongo_event_fnl <- shim2022_bongo_event_fnl %>%
  mutate(eventRemarks = case_when(
    eventRemarks == "Day" ~ "Sampling event occurred during the day.",
    eventRemarks == "Night" ~ "Sampling event occurred during the night."))

# For the CCGS Sir John Franklin: 
franklin2022_bongo_meta <- franklin2022_bongo_meta %>% 
  select(`Station Name`, Year, Month, Day, `Local Time`, `UTC Offset`,
         decimalLatitude = `Latitude Degrees`, 
         decimalLongitude = `Longitude Degrees`,
         sampleSizeValue = `Volume Filtered (m3)`,
         minimumDepthInMeters = `Finish Depth`,
         maximumDepthInMeters = `Start Depth`,
         fieldNotes = `Flowmeter Flag`,
         eventRemarks = Notes) %>%
  mutate(samplingEffort = "volume seawater filtered", 
         sampleSizeUnit = "cubic meters",
         geodeticDatum = "WGS84",
         eventID = paste("IYS2022", "Franklin", 5, `Station Name`, "Bongo", "1", sep = "-"))

# Strip time
hrs <- abs(franklin2022_bongo_meta$`UTC Offset`) * 60 * 60
franklin2022_bongo_meta <- franklin2022_bongo_meta %>%
  mutate(Date = paste0(as_date(paste0(Year, "-", Month, "-", Day))),
         Time = as.POSIXct(`Local Time`, format = "%H:%M:%S"),
         Time = format(Time, "%H:%M:%S"),
         eventDate = as.POSIXct(paste0(Date, Time)),
         eventDate = eventDate + hrs,
         eventDate = paste0(format_ISO8601(eventDate), "Z"))

# Confirm that dates are still correct after standardizing to UTC.
dates <- franklin2022_bongo_meta %>% select(`Station Name`, Year, Month, Day, `Local Time`, `UTC Offset`, eventDate)

franklin2022_bongo_event_fnl <- franklin2022_bongo_meta %>%
  select(eventID, station = `Station Name`,
         eventDate, Year, Month, Day, decimalLatitude, decimalLongitude, minimumDepthInMeters,
         maximumDepthInMeters, sampleSizeValue, fieldNotes, samplingEffort, sampleSizeUnit,
         geodeticDatum, eventRemarks)


IYS2022_bongo_event <- rbind(tinro2022_bongo_event_fnl, nw2022_bongo_event_fnl, 
                             shim2022_bongo_event_fnl, franklin2022_bongo_event_fnl)

IYS2022_bongo_event <- IYS2022_bongo_event %>%
  mutate(footprintWKT = paste("POINT", " (", IYS2022_bongo_event$decimalLongitude, " ", IYS2022_bongo_event$decimalLatitude, ")"))

coordinates <- obistools::calculate_centroid(IYS2022_bongo_event$footprintWKT) %>% select(coordinateUncertaintyInMeters)

IYS2022_bongo_event <- cbind(IYS2022_bongo_event, coordinates)

# Remove NAs from the dataframe:
IYS2022_bongo_event[is.na(IYS2022_bongo_event)] <- ""
IYS2022_bongo_event <- as_tibble(IYS2022_bongo_event)

# Add language, modified and license columns:
IYS2022_bongo_event <- IYS2022_bongo_event %>%
  mutate(language = "en",
         modified = lubridate::today(),
         license = "https://creativecommons.org/licenses/by/4.0/legalcode",
         informationWithheld = "Contact data provider for information on abundance, sizes and biomass.")

# Save as .csv file
write_csv(IYS2022_bongo_event, here("standardized_data", "IYS2022_bongo_event.csv"))
```

Next, create the occurrence extensions - and then combine these. First the bongo occurrence data from the Shimada & NW Explorer:

```{r occurrence extension, eval = FALSE}
nw2022_bongo_occ <- nw2022_bongo_data %>%
  mutate(eventID = paste(station_event_id, net_number, sep = "-"),
         occurrenceID = paste(eventID, row_number(), sep = "-"),
         occurrenceStatus = "present",
         preparations = "Formalin")

shim2022_bongo_occ <- shim2022_bongo_data %>%
  mutate(eventID = paste(station_event_id, net_number, sep = "-"),
         occurrenceID = paste(eventID, row_number(), sep = "-"),
         occurrenceStatus = "present", 
         preparations = "Formalin")

# Combine these data frames:
shim_nw_bongo_occ <- rbind(nw2022_bongo_occ, shim2022_bongo_occ)

# Change sex, lifestage and remove NAs:
shim_nw_bongo_occ$sex[shim_nw_bongo_occ$sex == "F"] <- "female"
shim_nw_bongo_occ$sex[shim_nw_bongo_occ$sex == "M"] <- "male"
shim_nw_bongo_occ$sex[shim_nw_bongo_occ$sex == "N/A"] <- NA

shim_nw_bongo_occ$lifestage[shim_nw_bongo_occ$lifestage == "caliptopis"] <- "calyptopis"
shim_nw_bongo_occ$lifestage[shim_nw_bongo_occ$lifestage == "C4/C5"] <- "C4-5"
shim_nw_bongo_occ$lifestage[shim_nw_bongo_occ$lifestage == "N/A"] <- NA
  
# Standardize columns to Darwin Core:
shim_nw_bongo_occ <- shim_nw_bongo_occ %>%
  rename(verbatimIdentification = species_recorded)

# From the scientific_name column, create identificationQualifier column, then remove 'SP.', and add 'sp. indet' for Neocalanus Flemingeri/plumchrus:
shim_nw_bongo_occ$identificationQualifier <- ifelse(grepl("\\b SP.\\b|\\b SP\\b", shim_nw_bongo_occ$scientific_name), "sp. indet.", NA)
shim_nw_bongo_occ$identificationQualifier <- ifelse(grepl("NEOCALANUS FLEMINGERI/PLUMCHRUS", shim_nw_bongo_occ$scientific_name), 
                                                    "sp. indet.", shim_nw_bongo_occ$identificationQualifier)
shim_nw_bongo_occ$scientific_name <- gsub("\\b SP.\\b|\\b SP\\b", "", shim_nw_bongo_occ$scientific_name) 

# Remove any special characters (punctuation, brackets etc)
shim_nw_bongo_occ$scientific_name <- gsub("[[:punct:]]", "", shim_nw_bongo_occ$scientific_name)

# Finally, remove any references to lifestage or sex from the scientific_name column, as this information is captured in separate columns already:
shim_nw_bongo_occ$scientific_name <- gsub(" LARVAE| JUVENILES| FURCILIA| BRACTS| NURSE| MEDIUM| SMALL| EXTRA SMALL| NAUPLII| ZOEA| CALYPTOPIS| AF| AM| V$| IV| III| II| I$", "", shim_nw_bongo_occ$scientific_name)

manual_check <- shim_nw_bongo_occ %>% select(scientific_name, verbatimIdentification, sex, lifestage, identificationQualifier) %>% distinct()

# scientific names are all capitalized. Change this from e.g. CYPHOCARIS CHALLENGERI to Cyphocaris challengeri:
shim_nw_bongo_occ$scientific_name <- tolower(shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- Hmisc::capitalize(shim_nw_bongo_occ$scientific_name)

# Check accuracy of scientific names:
worms_id <- worrms::wm_records_names(unique(shim_nw_bongo_occ$scientific_name), marine_only = FALSE) %>% dplyr::bind_rows() %>% rename(scientific_name = scientificname)

# Find out which species are not found in the WoRMS database:
no_worms_id <- left_join(shim_nw_bongo_occ, worms_id, by = "scientific_name") %>% filter(is.na(AphiaID)) %>% distinct(scientific_name)

# Change the verbatimIdentification of IYS2022-NW-2-15-Bongo-1-876, where the species for scientificName and verbatimIdentification do not match, as per Alexei Pinchuk. 
shim_nw_bongo_occ <- shim_nw_bongo_occ %>%
  mutate(verbatimIdentification = ifelse(occurrenceID == "IYS2022-NW-2-15-Bongo-1-876", "SCOLECITHRICELLA OVATA AF", verbatimIdentification))

# 7 names have to be changed to match WoRMS accepted names. These have to be changed in the original data table
shim_nw_bongo_occ$scientific_name <- gsub("Fish", "Pisces", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Siphonophora", "Siphonophorae", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Metridia ochotensis", "Metridia okhotensis", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Neocalanus flemingeriplumchrus", "Neocalanus", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Squid", "Teuthida", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Gastropoda echinospira", "Gastropoda", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Oithona copepodids", "Oithona", shim_nw_bongo_occ$scientific_name)

# As we have now changed all the names in the original dataframe to fit the entries in the WoRMS database registry, we can use wm_records_names() again to find all the taxonomic information. 
shim_nw_bongo_worms_id <- worrms::wm_records_names(unique(shim_nw_bongo_occ$scientific_name), marine_only = FALSE) %>%
  dplyr::bind_rows() %>% rename(scientific_name = scientificname)

# After manual inspection, there are some AphiaIDs that need to be removed, as the species is listed multiple times.
shim_nw_bongo_worms_id <- filter(shim_nw_bongo_worms_id, !(AphiaID %in% c("534090", "999078")))

shim_nw_bongo_occ <- left_join(shim_nw_bongo_occ, shim_nw_bongo_worms_id, by = "scientific_name") 

shim_nw_bongo_occ <- shim_nw_bongo_occ %>%
  mutate(identificationRemarks = ifelse(verbatimIdentification == "ACARTIA LONGIREMIS AM" & sex == "female", "Sex is assumed to be correct as per Joanne Breckenridge.", NA))

shim_nw_bongo_final <- shim_nw_bongo_occ %>%
  select(verbatimIdentification, 
         lifeStage = lifestage, 
         sex, eventID, 
         individualCount = catch_count,
         organismQuantity = abundance_m3,
         scientificName = scientific_name,
         scientificNameAuthorship = authority,
         taxonomicStatus = status,
         taxonomicRank = rank,
         kingdom, phylum, class, order, family, genus, 
         scientificNameID = lsid,
         occurrenceID, occurrenceStatus, preparations, identificationQualifier, identificationRemarks) %>%
  mutate(specificEpithet = stringr::word(scientificName, 2),
         organismQuantityType = "individuals per cubic meter",
         previousIdentifications = "",
         identificationReferences = "")

# Remove NAs from the dataframe:
shim_nw_bongo_final[is.na(shim_nw_bongo_final)] <- ""
shim_nw_bongo_final <- as_tibble(shim_nw_bongo_final)
```

Next, the Bongo zooplankton data collected by the TINRO, which is provided in a different format: 

```{r TINRO bongo}
tinro2022_bongo_counts <- tinro2022_bongo_data[-c(1:4, 149:295),]
tinro2022_bongo_abund <- tinro2022_bongo_data[-c(1:151),]

tinro2022_bongo_counts <- tinro2022_bongo_counts %>%
  pivot_longer(cols = `1`:`32`,
               values_to = "counts",
               names_to = "station") 

tinro2022_bongo_abund <- tinro2022_bongo_abund %>%
  pivot_longer(cols = `1`:`32`,
               values_to = "ind/m3",
               names_to = "station")

tinro2022_bongo_occ <- left_join(tinro2022_bongo_counts, tinro2022_bongo_abund)

tinro2022_bongo_occ$station <- as.numeric(tinro2022_bongo_occ$station)
tinro2022_bongo_occ <- tinro2022_bongo_occ[order(tinro2022_bongo_occ$station),]
tinro2022_bongo_occ <- tinro2022_bongo_occ %>% rename(verbatimIdentification = `Station No`)
```

In the _Stage/length_ column, size ranges, sex and lifestages are sometimes included. We need to parse these out and include them in separate columns. If numerical values are included, these need to be included in a `size_range` column. If sex is included in the scientific name (i.e. 'AF' for adult female), include this in column `sex`. Lifestage, such as 'adult' (A) need to be included in `lifeStage` column.

```{r TINRO bongo cont}
tinro2022_bongo_occ <- tinro2022_bongo_occ %>%
  mutate(size_range = ifelse(grepl("\\d+", `Stage/length`), `Stage/length`, NA), 
         `Stage/length` = ifelse(grepl("\\d+", `Stage/length`), NA, `Stage/length`),
         sex = ifelse(grepl("F", `Stage/length`), "female", 
                      ifelse(grepl("M", `Stage/length`), "male", NA)), 
         `Stage/length` = ifelse(grepl("A", `Stage/length`), "C6", `Stage/length`)) %>% 
  rename(lifeStage = `Stage/length`) %>%
  mutate(eventID = paste("IYS2022", "TINRO", "3", station, "Bongo", "1", sep = "-")) %>%
  as.data.frame()

# Size (ranges) in the verbatimIdentification should also be included in the size_range column
tinro2022_bongo_occ <- tinro2022_bongo_occ %>%
  mutate(size_range = ifelse(grepl("0.5mm", verbatimIdentification), "0.5mm", size_range),
         size_range = ifelse(grepl("1.5mm", verbatimIdentification), "1.5mm", size_range),
         size_range = ifelse(grepl("2.5mm", verbatimIdentification), "2.5mm", size_range),
         size_range = ifelse(grepl("1mm", verbatimIdentification), "1mm", size_range))

# Remove 'Jelly fragment' observations from data as per JB, as there was only one taxonomist that recorded this:
tinro2022_bongo_occ <- tinro2022_bongo_occ[tinro2022_bongo_occ$verbatimIdentification != 'Jelly fragments', ]

# Change the lifestage in TINRO data as per JB
tinro2022_bongo_occ$lifeStage[tinro2022_bongo_occ$lifeStage == 'IV-V' ] <- 'C4-5'
tinro2022_bongo_occ$lifeStage[tinro2022_bongo_occ$lifeStage == 'V' ] <- 'C5'
tinro2022_bongo_occ$lifeStage[tinro2022_bongo_occ$lifeStage == 'IV' ] <- 'C4'
tinro2022_bongo_occ$lifeStage[tinro2022_bongo_occ$lifeStage == 'III' ] <- 'C3'
tinro2022_bongo_occ$lifeStage[tinro2022_bongo_occ$lifeStage == 'II' ] <- 'C2'
tinro2022_bongo_occ$lifeStage[tinro2022_bongo_occ$lifeStage == 'I' ] <- 'C1'
tinro2022_bongo_occ$lifeStage[tinro2022_bongo_occ$lifeStage == "cal"] <- "calyptopis"

# Lifestages in the verbatimidentification should also be included in the lifeStage column:
tinro2022_bongo_occ <- tinro2022_bongo_occ %>%
  mutate(lifeStage = ifelse(grepl("larvae", verbatimIdentification), "larvae", lifeStage),
         lifeStage = ifelse(grepl("juv.", verbatimIdentification), "juvenile", lifeStage),
         lifeStage = ifelse(grepl("fur", size_range), "furcilia", lifeStage),
         lifeStage = ifelse(grepl("egg", verbatimIdentification), "egg", lifeStage),
         lifeStage = ifelse(grepl("Crytoniscid", verbatimIdentification), "crytoniscid larva", lifeStage),
         lifeStage = ifelse(grepl("Microniscid", verbatimIdentification), "microniscid larva", lifeStage),
         lifeStage = ifelse(grepl("cyphonautes", verbatimIdentification), "cyphonautes", lifeStage))

# Add sex when notation included in the verbatimIdentification:
tinro2022_bongo_occ <- tinro2022_bongo_occ %>%
  mutate(sex = ifelse(verbatimIdentification == "Clausocalanus sp. - really small, 0.5mm  tiny 5th leg AF voucher", "female", sex),
         sex = ifelse(verbatimIdentification == "Clausocalanus sp. , 1.5mm  tiny 5th leg AF voucher", "female", sex))

# Create column 'identificationQualifier' to indicate uncertainty in species classification:
tinro2022_bongo_occ$identificationQualifier <- ifelse(grepl("\\b sp.|spp.", tinro2022_bongo_occ$verbatimIdentification), "sp. indet.", NA)
tinro2022_bongo_occ$identificationQualifier <- ifelse(grepl("Neocalanus plumchrus/flemmingi", tinro2022_bongo_occ$verbatimIdentification), "sp. indet.", tinro2022_bongo_occ$identificationQualifier)

# Next, duplicate the verbatimIdentification column so that we can make changes where necessary to the scientific names based on the WoRMS Registry:
tinro2022_bongo_occ$scientific_name <- tinro2022_bongo_occ$verbatimIdentification

# From this duplicated column, remove 'sp.' and 'spp.' to begin with;
tinro2022_bongo_occ$scientific_name <- gsub("\\b sp.\\b|\\b spp.\\b|\\b SP.\\b", "", tinro2022_bongo_occ$scientific_name) 

# Manual check to see if those changes have been made correctly:
manual_check <- tinro2022_bongo_occ %>% select(scientific_name, verbatimIdentification, sex, lifeStage, identificationQualifier, size_range) %>% distinct()

# Remove any special characters (punctuation, brackets etc)
tinro2022_bongo_occ$scientific_name <- gsub("[[:punct:]]", "", tinro2022_bongo_occ$scientific_name)

# Check accuracy of scientific names:
worms_id <- worrms::wm_records_names(unique(tinro2022_bongo_occ$scientific_name), marine_only = FALSE) %>% dplyr::bind_rows() %>% rename(scientific_name = scientificname)

# Find out which species are not found in the WoRMS database:
no_worms_id <- left_join(tinro2022_bongo_occ, worms_id, by = "scientific_name") %>% filter(is.na(AphiaID)) %>% distinct(scientific_name)

# 34 names have to be changed to match WoRMS accepted names. These have to be changed in the original data table (tinro2022_bongo_occ)
tinro2022_bongo_occ$scientific_name <- gsub("Scolethricella minor", "Scolecithricella minor", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Scolethricella ovata", "Scolecithricella ovata", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Gaetanus intermedius", "Gaetanus simplex", tinro2022_bongo_occ$scientific_name) # As per A. Pinchuk
tinro2022_bongo_occ$scientific_name <- gsub("Siphonophora", "Siphonophorae", tinro2022_bongo_occ$scientific_name) # As per A. Pinchuk
tinro2022_bongo_occ$scientific_name <- gsub("Neocalanus plumchrusflemmingi", "Neocalanus", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Eucheata elongata", "Euchaeta elongata", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Candacia columbia", "Candacia columbiae", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Clausocalanus sp  really small 05mm  tiny 5th leg AF voucher", "Clausocalanus", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Clausocalanus sp  15mm  tiny 5th leg AF voucher", "Clausocalanus", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Clausocalanus sp 1mm", "Clausocalanus", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Clausocalanus sp 25mm", "Clausocalanus", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Mesocalanus tenniucornus", "Mesocalanus tenuicornis", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Acartia longirmis", "Acartia longiremis", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Lucicutia 15mm", "Lucicutia", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Hyperia juv", "Hyperia", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Thysanoesa inspinata", "Thysanoessa inspinata", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Thysanoesa spinifer", "Thysanoessa spinifera", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Thysanoesa inermis", "Thysanoessa inermis", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Thysanoesa longipes", "Thysanoessa longipes", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Chionocetes", "Chionoecetes", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Crytoniscid parasitic isopod larvae", "Isopoda", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Microniscid parasitic isopod larvae", "Isopoda", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Polycheata", "Polychaeta", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Tyroscrolex leafy stick", "Typhloscolex muelleri", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Limiacina helicina", "Limacina helicina", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Squid larvae", "Teuthida", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Eukronia hamata", "Eukrohnia hamata", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Sagitta scrippae  larger transparent fellow", "Sagitta scrippsae", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Oikopluera", "Oikopleura", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Fritilaria", "Fritillaria", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Siphonophore bract", "Siphonophorae", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Fish egg", "Pisces", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Fish larvae", "Pisces", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Brozoan cyphonautes", "Bryozoa", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Pumkin boy unknown critter could be sea anemone larvae", "Zoanthidea", tinro2022_bongo_occ$scientific_name) # As per A. Pinchuk

# Add identificationRemarks where necessary/described in the verbatimIdentification: 
tinro2022_bongo_occ <- tinro2022_bongo_occ %>%
  mutate(identificationRemarks = ifelse(grepl("larger transparent fellow", verbatimIdentification), "larger transparent fellow", NA))

# As we have now changed all the names in the original dataframe to fit the entries in the WoRMS database registry, we can use wm_records_names() again to find all the taxonomic information. 
tinro2022_bongo_worms_id <- worrms::wm_records_names(unique(tinro2022_bongo_occ$scientific_name), marine_only = FALSE) %>%
  dplyr::bind_rows() %>% rename(scientific_name = scientificname)

# After manual inspection, there are some AphiaIDs that need to be removed, as the species is listed multiple times.
tinro2022_bongo_worms_id <- filter(tinro2022_bongo_worms_id, !(AphiaID %in% c("534090", "835292", "503291")))

# Check to see if we missed any:
unique_taxa <- as.data.frame(unique(tinro2022_bongo_occ$scientific_name))
names(unique_taxa)[1] <- "scientific_name"
temp_taxa <- left_join(unique_taxa, tinro2022_bongo_worms_id) %>% filter(is.na(AphiaID)) # should be empty.
print(temp_taxa)

tinro2022_bongo_occ <- left_join(tinro2022_bongo_occ, tinro2022_bongo_worms_id, by = "scientific_name") %>%
  group_by(eventID) %>%
  mutate(id = seq_along(eventID)) %>%
  mutate(occurrenceID = paste(eventID, id, sep = "-"),
         occurrenceStatus = "present",
         preparations = "Formalin")

tinro2022_bongo_final <- tinro2022_bongo_occ %>%
  select(verbatimIdentification, lifeStage, sex, eventID, identificationQualifier, 
         individualCount = counts,
         organismQuantity = `ind/m3`,
         size_range,
         scientificName = scientific_name,
         scientificNameAuthorship = authority,
         taxonomicStatus = status,
         taxonomicRank = rank,
         kingdom, phylum, class, order, family, genus, 
         scientificNameID = lsid,
         occurrenceID, occurrenceStatus, preparations, identificationRemarks) %>%
  mutate(specificEpithet = stringr::word(scientificName, 2),
         organismQuantityType = "individuals per cubic meter",
         identificationReferences = "",
         previousIdentifications = "")

# Remove NAs from the dataframe:
tinro2022_bongo_final[is.na(tinro2022_bongo_final)] <- ""
tinro2022_bongo_final <- as_tibble(tinro2022_bongo_final)
```

Finally, the Franklin bongo occurrence data, which is also provided in a different format:

```{r Franklin bongo, eval = FALSE}
franklin2022 <- franklin2022_bongo_data %>%
  dplyr::rename(Abundance = `Abundance(#/m3)`,
                scientificName = Name) %>%
  mutate(verbatimIdentification = scientificName)

franklin2022$stage_length <- sub('.*\\ ', '', franklin2022$scientificName)
franklin2022$lifestage <- NA # create dummy column

franklin2022 <- franklin2022 %>%
  mutate(scientificName = word(scientificName, 1, -2))

# Remove Rhizarian taxa, and associated Station:
franklin2022 <- franklin2022[franklin2022$'Phylum:' !='Rhizaria', ]

# Dealing with some Franklin-specific issues. From readme we know *sp. = spp.
franklin2022$scientificName <- str_replace_all(franklin2022$scientificName, fixed('*sp.'), "spp.")

# For all observations with sp, spp. and aff include information in identificationQualifier column:
franklin2022 <- franklin2022 %>%
  mutate(identificationQualifier = ifelse(grepl("\\b spp.", franklin2022$scientificName), "sp. indet.", NA),
         identificationQualifier = ifelse(grepl(" aff", franklin2022$scientificName), "sp. aff.", identificationQualifier))

franklin2022$scientificName <- gsub("[[:punct:]]", "", franklin2022$scientificName)
franklin2022$scientificName <- gsub("\\b spp\\b", "", franklin2022$scientificName)
franklin2022$scientificName <- trimws(franklin2022$scientificName, "r")

# Parse out lifestage in separate column:
franklin2022$lifestage = ifelse(grepl("juvenile", franklin2022$scientificName),"juvenile", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("cyprids", franklin2022$scientificName), "cyprid", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("eggs", franklin2022$scientificName), "egg", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("eudoxid", franklin2022$scientificName), "eudoxid", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("flexion", franklin2022$scientificName), "flexion", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("gas floats", franklin2022$scientificName), "gas floats", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("megalops", franklin2022$scientificName), "megalopa", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("mysis", franklin2022$scientificName), "mysis", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("nauplii", franklin2022$scientificName), "nauplii", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("nectophore", franklin2022$scientificName), "nectophore", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("old nurse", franklin2022$scientificName), "nurse", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("paralarvae", franklin2022$scientificName), "paralarvae", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("\\blarvae\\b", franklin2022$scientificName), "larvae", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("polytroch", franklin2022$scientificName), "polytroch", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("postflexion", franklin2022$scientificName), "postflexion", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("preflexion", franklin2022$scientificName), "preflexion", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("calyptopis", franklin2022$scientificName), "calyptopis", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("veligers", franklin2022$scientificName), "veliger", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("furcilia", franklin2022$scientificName), "furcilia", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("zoea", franklin2022$scientificName), "zoea", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("protozoea \\(or calyptopis\\)", franklin2022$scientificName), "calyptopis", franklin2022$lifestage)
franklin2022$lifestage = ifelse(grepl("zoea \\(or furcilia\\)", franklin2022$scientificName), "furcilia", franklin2022$lifestage)

# Change some lifestages as per Joanne Breckenridge:
franklin2022$lifestage[franklin2022$scientificName == "Thysanoessa inspinata" & franklin2022$lifestage == "zoea"] <- "furcilia"
franklin2022$lifestage[franklin2022$scientificName == "Stylocheiron spp." & franklin2022$lifestage == "zoea"] <- "furcilia"

# 13 names will have to be adjusted to match with the WoRMS registry. Change these in the original dataframe:
franklin2022$scientificName <- gsub("Gastropoda trich larvae", "Gastropoda", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Euphausiidae protozoea or calyptopis", "Euphausiidae", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Euphausiidae zoea or furcilia", "Euphausiidae", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Metridia aff lucens", "Metridia lucens", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Conchoecia rudjakovi", "Conchoecia rudyakovi", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Conchoecinae", "Conchoeciinae", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Oikopleura labradoriensis", "Oikopleura (Vexillaria) labradoriensis", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Limacina helicina acuta", "Limacina helicina", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Epicarid", "Epicaridea", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Doliolid", "Doliolidae", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Fish", "Pisces", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Oikopleura longicauda", "Oikopleura (Coecaria) longicauda", franklin2022$scientificName)
franklin2022$scientificName <- gsub("Alacia aff major", "Alacia major", franklin2022$scientificName)


# Remove some lifestages from the scientific names. 
franklin2022$scientificName <- gsub("\\bspp. trich\\b", "", franklin2022$scientificName)
franklin2022$scientificName <- gsub("\\bspp. \\(old nurse\\)\\b", "", franklin2022$scientificName)
franklin2022$scientificName <- gsub("old nurse", "", franklin2022$scientificName)
franklin2022$scientificName <- gsub("paralarvae", "", franklin2022$scientificName)
franklin2022$scientificName <- gsub("larvae", "", franklin2022$scientificName)

#extract 'Length' info, after creating the dummy column:
franklin2022$length <- NA
franklin2022$length = ifelse(grepl("s0", franklin2022$stage_length),"< 2mm", franklin2022$length)
franklin2022$length = ifelse(grepl("s1", franklin2022$stage_length),"< 5mm", franklin2022$length)
franklin2022$length = ifelse(grepl("s2", franklin2022$stage_length),">= 5mm < 10mm", franklin2022$length)
franklin2022$length = ifelse(grepl("s3", franklin2022$stage_length),">= 10mm", franklin2022$length)
franklin2022$length = ifelse(grepl("s4", franklin2022$stage_length),"> average", franklin2022$length)

# Add sex:
franklin2022$sex <- NA
franklin2022$sex = ifelse(grepl("M", franklin2022$stage_length), "male", franklin2022$sex)
franklin2022$sex = ifelse(grepl("F", franklin2022$stage_length), "female", franklin2022$sex)

# Rename lifestages:
franklin2022$lifestage[franklin2022$stage_length == '15'] <- 'C1-5'
franklin2022$lifestage[franklin2022$stage_length == '56'] <- 'C5-6'
franklin2022$lifestage[franklin2022$stage_length == '1'] <- 'C1'
franklin2022$lifestage[franklin2022$stage_length == '2'] <- 'C2'
franklin2022$lifestage[franklin2022$stage_length == '3'] <- 'C3'
franklin2022$lifestage[franklin2022$stage_length == '4M'] <- 'C4'
franklin2022$lifestage[franklin2022$stage_length == '4F'] <- 'C4'
franklin2022$lifestage[franklin2022$stage_length == '4'] <- 'C4'
franklin2022$lifestage[franklin2022$stage_length == '5M'] <- 'C5'
franklin2022$lifestage[franklin2022$stage_length == '5F'] <- 'C5'
franklin2022$lifestage[franklin2022$stage_length == '5'] <- 'C5'
franklin2022$lifestage[franklin2022$stage_length == '6F'] <- 'C6'
franklin2022$lifestage[franklin2022$stage_length == '6M'] <- 'C6'

# Remove lifestages from the scientific name:
franklin2022$scientificName <- franklin2022$scientificName %>% stringr::str_remove('cyprids|eggs|eudoxid|flexion|gas floats|juvenile|megalops|mysis|nauplii|nectophore|\\(old  nurse\\)|paralarvae|larvae|polytroch|postflexion|preflexion|protozoea \\(or calyptopis\\)|veligers|zoea \\(or furcilia\\)|zoea')
franklin2022$scientificName <- trimws(franklin2022$scientificName, "r")

franklin2022$scientificName <- gsub("Siphonophora", "Siphonophorae", franklin2022$scientificName)

# Next, we're going to match the observed taxa with the WoRMS Registry. 
unique_spp <- franklin2022 %>% select(scientificName) %>% unique() %>% as.data.frame() %>% rename(scientific_name = scientificName)
worms <- worrms::wm_records_names(unique_spp$scientific_name, marine_only = F) %>% dplyr::bind_rows()

# Remove AphiaIDs that are incorrect. .
franklin2022_bongo_worms_id <- filter(worms, !(AphiaID %in% c("410743", "603038", "14775", "588510", "956054", "956065", "163921", "835292"))) %>%
  select(scientificName = scientificname, 
         scientificNameID = lsid,
         scientificNameAuthorship = authority,
         taxonomicStatus = status,
         taxonomicRank = rank, 
         kingdom, phylum, class, order, family, genus, AphiaID)

# Connect this information back to the franklin2022 dataframe:
franklin2022 <- left_join(franklin2022, franklin2022_bongo_worms_id, by = "scientificName")

# Somehow, 4 rows show up that contain only NA values. Remove these:
franklin2022 <- subset(franklin2022, rowSums(is.na(franklin2022)) != ncol(franklin2022))

# Perform a manual check
manual_check <- franklin2022 %>% select(verbatimIdentification, scientificName, stage_length, 
                                        lifestage, sex, length, identificationQualifier) %>% distinct()

# There are still scientificNames that do not have a corresponding AphiaID. For these species, we change the scientificName to a blank cell to avoid confusion. The species will still be recorded under 'verbatimIdentification.
franklin2022 <- franklin2022 %>% 
  mutate(scientificName = ifelse(is.na(AphiaID), NA, scientificName))

# Remove rows that are all NA:
franklin2022 <- franklin2022 %>% filter_all(any_vars(!is.na(.)))
# You want to use this because na.omit() removes _any_ row that contains NA. lifeStage column also contains NA, but this you want to retain.

franklin2022_bongo_final <- franklin2022 %>%
  select(Station, 
         verbatimIdentification, 
         lifeStage = lifestage, sex, 
         organismQuantity = Abundance,
         size_range = length,
         scientificName,
         scientificNameAuthorship,
         taxonomicStatus,
         taxonomicRank,
         kingdom, phylum, class, order, family, genus, 
         scientificNameID,
         identificationQualifier) %>%
  mutate(eventID = paste("IYS2022", "Franklin", "5", Station, "Bongo", "1", sep = "-")) %>%
  group_by(eventID) %>%
  mutate(occurrenceID = paste(eventID, row_number(), sep = "-"),
         occurrenceStatus = "present",
         individualCount = NA,
         preparations = "formalin", 
         specificEpithet = stringr::word(scientificName, 2),
         organismQuantityType = "individuals per cubic meter",
         identificationRemarks = "",
         previousIdentifications = "",
         identificationReferences = "") %>%
  ungroup()

# specificEpithet needs to change for Oikopleura (Vexillaria) labradoriensis":
franklin2022_bongo_final <- franklin2022_bongo_final %>%
  mutate(specificEpithet = ifelse(scientificName == "Oikopleura (Vexillaria) labradoriensis", "labradoriensis", specificEpithet),
         specificEpithet = ifelse(scientificName == "Oikopleura (Coecaria) longicauda", "longicauda", specificEpithet))

# Remove NAs from the dataframe:
franklin2022_bongo_final[is.na(franklin2022_bongo_final)] <- ""
franklin2022_bongo_final <- as_tibble(franklin2022_bongo_final)
```

Combine these occurrence extensions into a single dataframe and save locally:

```{r IYS2022 bongo}
IYS2022_bongo_final <- plyr::rbind.fill(shim_nw_bongo_final, tinro2022_bongo_final,
                                        franklin2022_bongo_final) %>% as.data.frame()

# Remove brackets from the scientificNameAuthorship, then join it to the scientificName following format:
# <scientificName> (scientificNameAuthorship)
IYS2022_bongo_final <- IYS2022_bongo_final %>%
  mutate(scientificNameAuthorship = str_replace_all(scientificNameAuthorship, "\\(|\\)", ""),
         scientificNameAuthorship = ifelse(scientificNameAuthorship == "", NA, scientificNameAuthorship))

IYS2022_bongo_final <- IYS2022_bongo_final %>%
  mutate(scientificName = ifelse(!is.na(scientificNameAuthorship), 
                                 paste0(scientificName, " (", scientificNameAuthorship, ")"),
                                 scientificName))

#TODO: Make some changes as per Joanne Breckenridge September 28, 2023:
IYS2022_bongo_final <- IYS2022_bongo_final %>%
  mutate(lifeStage = ifelse(grepl("bract|BRACTS", verbatimIdentification), "zooid", lifeStage),
         lifeStage = ifelse(grepl("trich", verbatimIdentification), "trochophore", lifeStage),
         lifeStage = ifelse(grepl("old nurse", verbatimIdentification), "nurse", lifeStage),
         lifeStage = ifelse(grepl("cyphonautes", verbatimIdentification), "cyphonautes", lifeStage),
         lifeStage = ifelse(grepl("SQUID LARVAE", verbatimIdentification), "larvae", lifeStage))

IYS2022_bongo_final <- IYS2022_bongo_final %>%
  mutate(identificationRemarks = ifelse(grepl("Limacina helicina acuta", verbatimIdentification), 
                                        "Morphotype: acuta", identificationRemarks))

# Change scientificName of Scolecithricella ovata to PSEUDOAMALLOTHRIX OVATA, as per Alexei Pinchuk and Moira Galbraith. Scolecithricella ovata is outdated. 
# Include previous identification in separate column. 
IYS2022_bongo_final <- IYS2022_bongo_final %>%
  mutate(previousIdentifications = ifelse(scientificName == "Scolecithricella ovata (Farran, 1905)", "Scolecithricella ovata", ""),
         identificationReferences = ifelse(scientificName == "Scolecithricella ovata (Farran, 1905)", "https://copepodes.obs-banyuls.fr/en/fichesp.php?sp=1465", identificationReferences),
         identificationRemarks = ifelse(scientificName == "Scolecithricella ovata (Farran, 1905)", "Previous identification outdated as per data provider.", identificationRemarks),
         scientificName = ifelse(scientificName == "Scolecithricella ovata (Farran, 1905)", "Pseudoamallothrix ovata (Farran, 1905)", scientificName))

# Add identificationReference and identificationRemarks for Gaetanus simplex
IYS2022_bongo_final <- IYS2022_bongo_final %>%
  mutate(identificationReferences = ifelse(scientificName == "Gaetanus simplex (Brodsky, 1950)" & 
                                             verbatimIdentification == "Gaetanus intermedius",
                                           "https://copepodes.obs-banyuls.fr/en/fichesp.php?sp=203", identificationReferences),
         identificationRemarks = ifelse(scientificName == "Gaetanus simplex (Brodsky, 1950)" & 
                                          verbatimIdentification == "Gaetanus intermedius",
                                        "Species revised as per Alexei Pinchuk.", identificationRemarks),
         previousIdentifications = ifelse(scientificName == "Gaetanus simplex (Brodsky, 1950)" & 
                                            verbatimIdentification == "Gaetanus intermedius",
                                          "Gaetanus intermedius", previousIdentifications))

# Replace N/A with blanks in the sex, lifestage and scientificNameAuthorship columns:
IYS2022_bongo_final$scientificNameAuthorship <- gsub("NA", "", IYS2022_bongo_final$scientificNameAuthorship)
IYS2022_bongo_final$lifeStage <- gsub("NA", "", IYS2022_bongo_final$lifeStage)
IYS2022_bongo_final$sex <- gsub("NA", "", IYS2022_bongo_final$sex)

# Add basisOfRecord (required):
IYS2022_bongo_final$basisOfRecord <- "HumanObservation"

# For observations with identificationQualifier, include reasoning in the identificationRemarks. The general reasoning has been provided by Moira G. 
IYS2022_bongo_final <- IYS2022_bongo_final %>%
  mutate(identificationRemarks = ifelse(identificationQualifier == "sp. aff.", 
                                        "Taxa documented is the closest affiliation to taxa observed, but not the taxa observed.",
                                        identificationRemarks),
         identificationRemarks = ifelse(identificationQualifier == "sp. indet.", 
                                        "Taxa is within this taxonomic rank but cannot be identified further due to life stage, missing body parts or due to the destructive nature of the sampling, preservation and analysis process.", 
                                        identificationRemarks))

# For now, remove the individualCount, organismQuantity and organismQuantityType columns until approved for publication:
IYS2022_bongo_occ <- IYS2022_bongo_final %>% select(-c("individualCount", "organismQuantity", "organismQuantityType", "size_range", "Station"))

# Save as .csv file
write_csv(IYS2022_bongo_occ, here("standardized_data", "IYS2022_bongo_occ.csv"))

# I will also generate a small occ file with the unique species occurrences, to manually check that I've made the necessary changes:
occ_manual_check <- IYS2022_bongo_occ %>%
  select(verbatimIdentification, scientificName, specificEpithet, sex, lifeStage, identificationQualifier, identificationRemarks,
         previousIdentifications, identificationReferences) %>% distinct()

write_csv(occ_manual_check, here("standardized_data", "occ_manual_check.csv"))
```

We want to standardize the data as well for the IYS Data Template. To this end, we'll have to include the metadata in the _Sampling Events_ sheet, and specimen data in _Bongo Specimen Data_. To put it in that format, combine the Event Core and occurrence extension and select and rename the correct columns:

```{r IYS Template, eval = FALSE}
bongo2022_sampling_event <- IYS2022_bongo_event %>%
   mutate(cruise_name = "IYS2022",
          dataset_doi = "https://doi.org/10.21966/ymv6-8024",
         vessel_name_abbr = case_when(
           grepl("Franklin", IYS2022_bongo_event$eventID) ~ "Franklin",
           grepl("TINRO", IYS2022_bongo_event$eventID) ~ "TINRO",
           grepl("NW", IYS2022_bongo_event$eventID) ~ "NW",
           grepl("Shimada", IYS2022_bongo_event$eventID) ~ "Shimada"),
         zone = case_when(
           vessel_name_abbr == "Franklin" ~ 5,
           vessel_name_abbr == "TINRO" ~ 3,
           vessel_name_abbr == "NW" ~ 2,
           vessel_name_abbr == "Shimada" ~ 4),
         station,
         event_type = "Bongo",
         time_zone_code = "UTC",
         event_date = as.Date(paste(Year,Month,Day, sep = "-")),
         time_start = gsub("/.*$", "", eventDate),
         time_start = lubridate::ymd_hms(time_start),
         time_start = format(time_start, format = "%H:%M:%S"),
         time_end = gsub(".*/", "", eventDate),
         time_end = lubridate::ymd_hms(time_end),
         time_end = format(time_end, format = "%H:%M:%S"),
         day_night = case_when(
           grepl("day", IYS2022_bongo_event$eventRemarks) ~ "Day",
           grepl("night", IYS2022_bongo_event$eventRemarks) ~ "Night"),
         day_of_year = lubridate::yday(event_date))

# Create some dummy columns:
bongo2022_sampling_event <- bongo2022_sampling_event %>%
  mutate(alternative_event_id = "",
         tow_speed_kilometers_per_hour = "",
         latitude_end_decdeg = "",
         longitude_end_decdeg = "",
         bottom_depth_meters = "",
         wind_direction_degrees = "",
         wind_speed_kilometers_per_hour = "",
         wave_height_meters = "",
         swell_height_meters = "",
         weather_description = "",
         comments = "")

#TODO: Code chunk below is horrible and needs fixing.
bongo2022_sampling_event <- bongo2022_sampling_event %>%
  mutate(time_end = ifelse(time_end == time_start, NA, time_end),
         sampling_duration_minutes = with(bongo2022_sampling_event, 
                                          difftime(as.POSIXct(bongo2022_sampling_event$time_start, format = "%H:%M:%S"), 
                                                   as.POSIXct(bongo2022_sampling_event$time_end, format = "%H:%M:%S"), 
                                                   units = "mins")),
         sampling_duration_minutes = round(sampling_duration_minutes, digits = 0),
         sampling_duration_minutes = sampling_duration_minutes*-1,
         sampling_duration_minutes = as.numeric(sampling_duration_minutes))

bongo2022_sampling_event <- bongo2022_sampling_event %>%
    select(cruise_name, vessel_name_abbr, zone, station, event_type, station_event_id = eventID, 
           alternative_event_id, event_date, 
           year = Year,
           month = Month,
           day = Day,
           time_start, time_end, sampling_duration_minutes, day_night, time_zone_code, 
           minimum_sampling_depth_meters = minimumDepthInMeters,
           maximum_sampling_depth_meters = maximumDepthInMeters,
           tow_speed_kilometers_per_hour,
           latitude_start_decdeg = decimalLatitude,
           longitude_start_decdeg = decimalLongitude,
           latitude_end_decdeg, longitude_end_decdeg, bottom_depth_meters, wind_direction_degrees,
           wind_speed_kilometers_per_hour,
           wave_height_meters, swell_height_meters, weather_description, comments, day_of_year, dataset_doi)

col_order <- c("cruise_name", "vessel_name_abbr", "zone", "station", "event_type", "station_event_id",
               "alternative_event_id", "event_date", "year", "month", "day", "time_start", "time_end",
               "sampling_duration_minutes", "day_night", "time_zone_code","minimum_sampling_depth_meters",
               "maximum_sampling_depth_meters", "tow_speed_kilometers_per_hour", "latitude_start_decdeg",
               "longitude_start_decdeg", "latitude_end_decdeg", "longitude_end_decdeg", "bottom_depth_meters",
               "wind_direction_degrees", "wind_speed_kilometers_per_hour", "wave_height_meters", 
               "swell_height_meters", "weather_description", "comments", "day_of_year", "dataset_doi")
bongo2022_sampling_event <- bongo2022_sampling_event[, col_order]

# Save locally:
write_csv(bongo2022_sampling_event, here("IYS_data_template", "Bongo_Sampling_Event.csv"))

# Create Bongo Specimen Data:
bongo2022_template <- left_join(IYS2022_bongo_event, IYS2022_bongo_final, by = "eventID") %>%
  select(station_event_id = eventID,
         catch_id = occurrenceID,
         scientific_name = scientificName,
         verbatimIdentification,
         taxonomic_rank = taxonomicRank,
         lifestage = lifeStage,
         sex,
         size_range,
         preservation_method = preparations,
         catch_count = individualCount,
         abundance_m3 = organismQuantity,
         flowmeter_volume_filtered_m3 = sampleSizeValue) %>%
  mutate(net_number = 1,
         prop_total_sample = "",
         sf_proc = "",
         common_name = "",
         identified_by = "",
         date_identified = "",
         count_method = "Total", #TODO: confirm this
         depth_volume_filtered_m3 = "",
         comments = "") #TODO: this could be 'eventRemarks'

# Drop rows where abundance_m3 is 0
bongo2022_template <- bongo2022_template %>% filter(!abundance_m3 == 0)

# Compared to the 2019 and 2020 data, we should still include information on the proportion of the sample processed when doing taxonomy for each size fraction (prop_sf_proc). This information is included in the zoop data_raw counts sheet:

sf <- read_excel(here("original_data", "7-14 2022 Bongo Logbook-TINRO_clean.xlsx"), sheet = "zoop data_raw counts")
sf <- sf[-c(1:6),]

# Select species column
sf_species <- sf[, 1]
colnames(sf_species)[1] <- "verbatimIdentification"

# Select only the columns where `total counted per split` is NA, as these columns depict 1) the lifestage (col #1) and 2) the proportion size fractionated:
col_odd <- seq_len(ncol(sf)) %% 2
sf <- sf[ , col_odd == 0]

# Combine species column with columns associated with the proportion size fractionated:
new_sf <- cbind(sf_species, sf)

# Change column headers, and adjust class where necessary:
new_sf <- setNames(new_sf, c("verbatimIdentification", "Stage/length", "1", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12",
                             "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32"))

new_sf$`1` <- as.numeric(new_sf$`1`)

# pivot long:
new_sf <- new_sf %>%
  pivot_longer(cols = 3:33,
               values_to = "prop_sf_proc",
               names_to = "station") %>%
  mutate(station_event_id = paste("IYS2022", "TINRO", "3", station, "Bongo", "1", sep = "-")) %>%
  drop_na(prop_sf_proc)

# Parse out `Stage/length` column into two separate columns. We have to do this to properly match prop_sf_proc to the correct species/sex/lifestage combination.
new_sf <- new_sf %>%
  mutate(size_range = ifelse(grepl("\\d+", `Stage/length`), `Stage/length`, NA), 
         `Stage/length` = ifelse(grepl("\\d+", `Stage/length`), NA, `Stage/length`), 
         sex = ifelse(grepl("F", `Stage/length`), "female", 
                      ifelse(grepl("M", `Stage/length`), "male", NA)), 
         `Stage/length` = ifelse(grepl("A", `Stage/length`), "Adult", `Stage/length`)) %>% 
  rename(lifestage = `Stage/length`) %>%
  select(verbatimIdentification, lifestage, prop_sf_proc, station_event_id, sex, size_range) %>%
  distinct()

# Lifestages in the verbatimidentification should also be included in the lifeStage column:
new_sf <- new_sf %>%
  mutate(lifestage = ifelse(grepl("larvae", verbatimIdentification), "larvae", lifestage),
         lifestage = ifelse(grepl("juv.", verbatimIdentification), "juvenile", lifestage),
         lifestage = ifelse(grepl("egg", verbatimIdentification), "egg", lifestage))

# Remove NAs from the dataframe:
new_sf[is.na(new_sf)] <- ""
new_sf <- as.data.frame(new_sf)

# Integrate within the IYS Data Template:
bongo2022_template <- left_join(bongo2022_template, new_sf, 
                                by = c("verbatimIdentification", "station_event_id", "lifestage", "sex", "size_range"))

col_order <- c("station_event_id", "net_number", "catch_id", "scientific_name", "verbatimIdentification",
               "taxonomic_rank",
               "prop_total_sample", "sf_proc", "prop_sf_proc", "lifestage", "sex", "common_name", "identified_by",
               "date_identified", "preservation_method", "catch_count", "size_range", "count_method", "abundance_m3",
               "flowmeter_volume_filtered_m3", "depth_volume_filtered_m3", "comments")
bongo2022_template <- bongo2022_template[, col_order]

bongo2022_template[is.na(bongo2022_template)] <- ""
bongo2022_template <- as.data.frame(bongo2022_template)

# Save locally:
write_csv(bongo2022_template, here("IYS_data_template", "Bongo_Specimen_Data.csv"))
```

Read these two data tables into a single IYS Zooplankton Template workbook:

```{r}
library(xlsx)
write.xlsx(bongo2022_sampling_event, file="IYS2022_Zooplankton_Template.xlsx", sheetName="Sampling_Events", row.names=FALSE)
write.xlsx(bongo2022_template, file="IYS2022_Zooplankton_Template.xlsx", sheetName="Bongo_Specimen_Data", append=TRUE,
           row.names=FALSE)
```


Finally, develop the extended measurements or facts extensions and combine them.

Bottom depth:

```{r bottom_depth, eval = FALSE}
bongo2022_bottomdepth <- tinro2022_bongo_event %>%
  select(eventID,
         Depth_m) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = Depth_m,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementType = recode(measurementType,
                                 Depth_m = "bottom_depth"),
         measurementID = paste(eventID, measurementType, sep = "-")) %>%
  mutate(measurementTypeID = case_when(
    measurementType == "bottom_depth" ~ "http://vocab.nerc.ac.uk/collection/C00/current/SCILOG/"),
         measurementUnit = case_when(
    measurementType == "bottom_depth" ~ "meter"),
         measurementUnitID = case_when(
    measurementUnit == "meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/ULAA/"),
    measurementValueID = NA) %>%
  select(eventID, measurementID, measurementType, measurementTypeID, measurementValue, measurementValueID,
         measurementUnit, measurementUnitID)
```

Sampling effort:

``` {r sampling effort, eval = FALSE}
bongo2022_sampling <- tinro2022_bongo_event %>%
  select(eventID, 
         `Vol filtered (m^3)`) %>%
  mutate(speed_tow = 1) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = `Vol filtered (m^3)`:speed_tow,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementType = recode(measurementType,
                                 `Vol filtered (m^3)` = "volume_filtered"),
         measurementID = paste(eventID, measurementType, sep = "-"),
         measurementTypeID = case_when(
           measurementType == "volume_filtered" ~ "http://vocab.nerc.ac.uk/collection/P09/current/VOLF/", 
           measurementType == "speed_tow" ~ "http://vocab.nerc.ac.uk/collection/P01/current/TOWSPEED/"),
  measurementUnit = case_when(
    measurementType == "volume_filtered" ~ "cubic meter",
    measurementType == "speed_tow" ~ "meter per second"),
  measurementUnitID = case_when(
    measurementUnit == "cubic meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/MCUB/",
    measurementUnit == "meter per second" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UVAA/"),
  measurementValueID = NA) %>%
    select(eventID, measurementID, measurementType, measurementTypeID, measurementValue, measurementValueID,
           measurementUnit, measurementUnitID)
```

Next, add information on the _sampling instrument_. Information on the mesh size and sampling instrument opening came from the Cruise Report and is verified by the data provider. 

``` {r samplingInstrument, eval = FALSE}
bongo2022_instrument <- tinro2022_bongo_event %>%
  select(eventID,
         Gear) %>%
  mutate(bongo_mesh = 236,
         bongo_opening = 0.6) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = Gear:bongo_opening,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementID = paste(eventID, "bongo", measurementType, sep = ":"),
         measurementTypeID = case_when(
           measurementType == "Gear" ~ "http://vocab.nerc.ac.uk/collection/Q01/current/Q0100002/",
           measurementType == "bongo_mesh" ~ "http://vocab.nerc.ac.uk/collection/Q01/current/Q0100015/",
           measurementType == "bongo_opening" ~ "http://vocab.nerc.ac.uk/collection/Q01/current/Q0100017/"))

bongo2022_instrument <- bongo2022_instrument %>%
  mutate(measurementUnit = case_when(
           measurementType == "bongo_mesh" ~ "micrometer",
           measurementType == "bongo_opening" ~ "square meter"),
         measurementUnitID = case_when(
           measurementUnit == "micrometer" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UMIC/",
           measurementUnit == "square meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UMSQ/"),
         measurementValueID = case_when(
           measurementValue == "Bongo" ~ "http://vocab.nerc.ac.uk/collection/L22/current/NETT0176/")) %>%
  select(eventID, measurementID, measurementType, measurementTypeID, measurementValue,
         measurementValueID, measurementUnit, measurementUnitID)
```

Next, we create the eMOF extension to associate the length, lifestage and sex measurements to the zooplankton.  

```{r eMOF, eval = FALSE}
bongo2022_emof <- tinro2022_bongo_occ %>%
  select(eventID,
         occurrenceID,
         lifeStage,
         sex,
         `ind/m3`, 
         size_range) %>%
  mutate_all(as.character)
```

```{r specimen size range, eval = FALSE}
#TODO: Create code to parse out size ranges into separate columns

range <- dplyr::filter(bongo2022_emof, grepl("-", size_range)) %>%
  separate(col = size_range, into = c("minimumLength", "maximumLength"), sep = "\\-") %>%
  mutate(size_range = " ")

# Remove any rows where length_mm contains a range, add two dummy columns (minimumLength and maximumLength) and use rbind() to merge `range` with this newly created dataframe.
minimum <- dplyr::filter(bongo2022_emof, grepl("\\+|>", size_range)) %>%
  mutate(minimumLength = as.character(unlist(regmatches(size_range, 
                                                      gregexpr("[[:digit:]]+\\.*[[:digit:]]*", size_range)))),
         maximumLength = " ")

temp <- bongo2022_emof[ -grep("\\+|>|-", bongo2022_emof$size_range), ] %>%
  mutate(minimumLength = " ",
         maximumLength = " ")

bongo2022_emof_fnl <- rbind(range, minimum, temp)

# Remove 'mm' from the size (range) columns:
bongo2022_emof_fnl[c("minimumLength", "maximumLength", "size_range")] <- lapply(bongo2022_emof_fnl[c("minimumLength", "maximumLength", "size_range")], function(y) gsub("mm", "", y))

# Make some adjustments:
bongo2022_emof_fnl$length_type <- ifelse(grepl("shell", bongo2022_emof_fnl$maximumLength), "shell length", NA)
bongo2022_emof_fnl$maximumLength <- gsub("[[:punct:]]", "", bongo2022_emof_fnl$maximumLength)
bongo2022_emof_fnl$maximumLength <- gsub(" shell length", "", bongo2022_emof_fnl$maximumLength)

#Remove 'fur' from minimumLength and add it to lifeStage column
bongo2022_emof_fnl$lifeStage <- ifelse(grepl("fur", bongo2022_emof_fnl$minimumLength), "furcilia", bongo2022_emof_fnl$lifeStage)
bongo2022_emof_fnl$minimumLength <- gsub("fur", "", bongo2022_emof_fnl$minimumLength)

# Remove 'lar' from size_range and add it to lifeStage column
bongo2022_emof_fnl$lifeStage <- ifelse(grepl("lar", bongo2022_emof_fnl$size_range), "larvae", bongo2022_emof_fnl$lifeStage)
bongo2022_emof_fnl$size_range <- gsub("lar", "", bongo2022_emof_fnl$size_range)

#TODO: Figure out what to do with 'Megalopa' in the Stage/Length column:

#Extract only sizes (numerical values) from size_range, remove all characters.
bongo2022_emof_fnl$size_range <- extract_numeric(bongo2022_emof_fnl$size_range)
```

So then finally the eMOF:

```{r emof cont., eval = FALSE}
bongo2022_emof_fnl <- bongo2022_emof_fnl %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = lifeStage:length_type,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementID = paste(occurrenceID, measurementType, sep = "-"),
    measurementTypeID = case_when(
      measurementType == "size_range" ~ "http://vocab.nerc.ac.uk/collection/P01/current/OBSINDLX/",
      measurementType == "maximumLength" ~ "http://vocab.nerc.ac.uk/collection/P01/current/OBSMAXLX/",
      measurementType == "minimumLength" ~ "http://vocab.nerc.ac.uk/collection/P01/current/OBSMINLX/",
      measurementType == "lifeStage" ~ "http://vocab.nerc.ac.uk/collection/P01/current/LSTAGE01/",
      measurementType == "sex" ~ "http://vocab.nerc.ac.uk/collection/P01/current/ENTSEX01/",
      measurementType == "ind/m3" ~ "http://vocab.nerc.ac.uk/collection/P01/current/SDBIOL01/",
      measurementType == "length_type" ~ " "), 
    measurementUnit = case_when(
      measurementType %in% c("length", "minimumLength", "maximumLength") ~ "millimeter",
      measurementType == "ind/m3" ~ "individuals per cubic meter"), 
    measurementUnitID = case_when(
      measurementUnit == "millimeter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UXMM/",
      measurementUnit == "individuals per cubic meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UPMM/"),
    measurementValueID = case_when(
      measurementValue == "male" ~ "http://vocab.nerc.ac.uk/collection/S10/current/S103/",
      measurementValue == "female" ~ "http://vocab.nerc.ac.uk/collection/S10/current/S102/",
      measurementValue == "Adult" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1116/",
      measurementValue == "V" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1112/",
      measurementValue == "IV" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1110/",
      measurementValue == "IV-V" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1111/",
      measurementValue == "III" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S118/",
      measurementValue == "II" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S117/",
      measurementValue == "I" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S111/",
      measurementValue == "juvenile" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1127/",
      measurementValue == "furcilia" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1123/",
      measurementValue == "egg" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1122/",
      measurementValue == "nauplii" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1130/",
      measurementValue == "cal" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1118/",
      measurementValue == "larvae" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1128/",
      measurementValue == "Megalopa" ~ "https://vocab.nerc.ac.uk/collection/S11/current/S1167/"),
    measurementRemarks = NA) %>%
  drop_na(measurementValue)

bongo2022_tinro_emof <- bind_rows(bongo2022_bottomdepth, bongo2022_sampling, bongo2022_instrument, bongo2022_emof_fnl)

# Make sure the folder path exists already (e.g. ./Bongo/tidy_data)
write_csv(bongo2022_tinro_emof, here("standardized_data", "bongo2022_tinro_emof.csv"))
```









