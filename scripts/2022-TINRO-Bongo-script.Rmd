---
title: "2022-TINRO-Bongo"
author: "Tim van der Stap"
date: "2022-09-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
library(tidyverse)
library(lubridate)
library(worrms)
library(dplyr)
library(obistools)
library(readxl)
library(parsedate)
library(googledrive)
library(here)
library(Hmisc)
```

Download the latest Data Template for the Shimada and NW Explorer to get the metadata associated with the Bongo tows:

```{r download, eval = FALSE}
download.file("https://github.com/international-year-of-the-salmon/2022-shimada-data-template/blob/main/IYS2022_Shimada_Data_template.xlsx?raw=true", here::here("IYS_data_template", "IYS2022_Shimada_data.xlsx"), quiet = TRUE, mode = "wb")

download.file("https://github.com/international-year-of-the-salmon/2022-NW-Data-Template/blob/main/IYS2022_NW_Data.xlsx?raw=true", here::here("IYS_data_template", "IYS2022_NW_Data.xlsx"), quiet = TRUE, mode = "wb")
```

## Read in files:

``` {r read_file, warning = FALSE}
tinro2022_bongo_metadata <- read_excel(here("original_data", "7-14 2022 Bongo Logbook-TINRO_clean.xlsx"), sheet = "Bongo metadata")
shimada2022_bongo_metadata <- read_excel(here("IYS_data_template", "IYS2022_Shimada_data.xlsx"), sheet = "4. SAMPLING EVENT INFO")
nw2022_bongo_metadata <- read_excel(here("IYS_data_template", "IYS2022_NW_Data.xlsx"), sheet = "Sampling_Event_Info")

tinro2022_bongo_data <- read_excel(here("original_data", "7-14 2022 Bongo Logbook-TINRO_clean.xlsx"), sheet = "zoop counts")
nw2022_bongo_data <- read_excel(here("IYS_data_template", "IYS2022_Shimada_NW_Zooplankton.xlsx"), sheet = "NWExplorer-Bongo-Taxonomy")
shim2022_bongo_data <- read_excel(here("IYS_data_template", "IYS2022_Shimada_NW_Zooplankton.xlsx"), sheet = "Shimada-Bongo-Taxonomy")
```

Create Event Core from the TINRO, NW Explorer and Shimada metadata:

``` {r event core, eval = FALSE}
tinro2022_bongo_event <- tinro2022_bongo_metadata %>%
  select(-`T, surf`) %>%
  mutate(Time = format(`Time, UTC`, "%H:%M:%S"),
         eventDate = format_iso_8601(as.POSIXct(paste(Date, Time),
                                                format = "%Y-%m-%d %H:%M:%S",
                                                tz = "UTC")),
         eventDate = str_replace(eventDate, "\\+00:00", "Z"))

tinro2022_bongo_event$Year <- as.numeric(format(as.Date(tinro2022_bongo_event$eventDate), "%Y"))
tinro2022_bongo_event$Month <- as.numeric(format(as.Date(tinro2022_bongo_event$eventDate), "%m"))
tinro2022_bongo_event$Day <- as.numeric(format(as.Date(tinro2022_bongo_event$eventDate), "%d"))

tinro2022_bongo_event <- tinro2022_bongo_event %>%
  mutate(zone = 3,
         eventID = paste("IYS2022", "TINRO", zone, Station, Gear, `Net number`, sep = "-"),
         minimumDepthInMeters = 0,
         geodeticDatum = "WGS84",
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters")

tinro2022_bongo_event_fnl <- tinro2022_bongo_event %>% 
  select(eventID, eventDate, Year, Month, Day,
         decimalLatitude = Latitude,
         decimalLongitude = Longitude,
         minimumDepthInMeters,
         maximumDepthInMeters = `Wire out_m`,
         sampleSizeValue = `Vol filtered (m^3)`,
         eventRemarks = Notes,
         samplingEffort, sampleSizeUnit, geodeticDatum)

# For F/V Northwest Explorer:
nw2022_bongo_metadata <- nw2022_bongo_metadata %>% filter(Event_Type == "Bongo") %>%
  mutate(eventID = paste(Station_Event_ID, "1", sep = "-"),
         minimumDepthInMeters = 0,
         geodeticDatum = "WGS84",
         sampleSizeValue = 70.65,
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters")

nw2022_bongo_metadata <- nw2022_bongo_metadata %>%
  mutate(Time_Start = as.POSIXct(Time_Start, format = "%H:%M:%S"),
         Time_End = as.POSIXct(Time_End, format = "%H:%M:%S")) %>%
  mutate(Time_Start = strftime(Time_Start, format = "%H:%M:%S"),
         Time_End = strftime(Time_End, format = "%H:%M:%S")) %>%
  mutate(eventDate_start = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_Start), tz ="UTC"))))

# For some tows, no Time_End was recorded. Therefore, for some eventDates, it will be a single recorded time, whereas for most it'll be a time span.
nw2022_bongo_metadata_1 <- nw2022_bongo_metadata %>%
  filter(is.na(Time_End)) %>%
  mutate(eventDate = paste0(eventDate_start, "Z"))

nw2022_bongo_metadata_2 <- nw2022_bongo_metadata %>%
  filter(!is.na(Time_End)) %>%
  mutate(eventDate_finish = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_End), tz = "UTC")), "Z"),
    eventDate = paste(eventDate_start, eventDate_finish, sep = "/"))

# Bind these rows again:
nw2022_bongo_metadata <- plyr::rbind.fill(nw2022_bongo_metadata_2, nw2022_bongo_metadata_1) 

nw2022_bongo_event_fnl  <- nw2022_bongo_metadata %>% 
  select(eventID, eventDate, Year, Month, Day,
         decimalLatitude = Latitude_Start_DecDeg,
         decimalLongitude = Longitude_Start_DecDeg,
         minimumDepthInMeters,
         maximumDepthInMeters = Maximum_Sampling_Depth,
         sampleSizeValue,
         eventRemarks = Comments,
         samplingEffort, sampleSizeUnit, geodeticDatum) 

# For NOAA Bell M. Shimada:
shim2022_bongo_metadata <- shimada2022_bongo_metadata %>% filter(Event_Type == "Bongo") %>%
  mutate(eventID = paste(Station_Event_ID, "1", sep = "-"),
         minimumDepthInMeters = 0,
         geodeticDatum = "WGS84",
         sampleSizeValue = 70.65,
         samplingEffort = "volume seawater filtered",
         sampleSizeUnit = "cubic meters")

shim2022_bongo_metadata <- shim2022_bongo_metadata %>%
  mutate(Time_Start = as.POSIXct(Time_Start, format = "%H:%M:%S"),
         Time_End = as.POSIXct(Time_End, format = "%H:%M:%S")) %>%
  mutate(Time_Start = strftime(Time_Start, format = "%H:%M:%S"),
         Time_End = strftime(Time_End, format = "%H:%M:%S")) %>%
  mutate(eventDate_start = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_Start), tz ="UTC"))),
         eventDate_finish = paste0(format_ISO8601(as.POSIXct(paste0(as_date(
    paste0(Year, "-", Month, "-", Day)), " ", Time_End), tz = "UTC")), "Z"),
    eventDate = paste(eventDate_start, eventDate_finish, sep = "/"))

shim2022_bongo_metadata_fnl  <- shim2022_bongo_metadata %>% 
  select(eventID, eventDate, Year, Month, Day,
         decimalLatitude = Latitude_Start_DecDeg,
         decimalLongitude = Longitude_Start_DecDeg,
         minimumDepthInMeters,
         maximumDepthInMeters = Maximum_Sampling_Depth_Meters,
         sampleSizeValue,
         eventRemarks = Comments,
         samplingEffort, sampleSizeUnit, geodeticDatum) 

IYS2022_bongo_event <- rbind(tinro2022_bongo_event_fnl, nw2022_bongo_event_fnl, shim2022_bongo_metadata_fnl)

IYS2022_bongo_event <- IYS2022_bongo_event %>%
  mutate(footprintWKT = paste("POINT", " (", IYS2022_bongo_event$decimalLongitude, " ", IYS2022_bongo_event$decimalLatitude, ")"))

coordinates <- obistools::calculate_centroid(IYS2022_bongo_event$footprintWKT) %>% select(coordinateUncertaintyInMeters)

IYS2022_bongo_event <- cbind(IYS2022_bongo_event, coordinates)

# Remove NAs from the dataframe:
IYS2022_bongo_event[is.na(IYS2022_bongo_event)] <- ""
IYS2022_bongo_event <- as.data.frame(IYS2022_bongo_event)

# Add language, modified and license columns:
IYS2022_bongo_event <- IYS2022_bongo_event %>%
  mutate(language = "en",
         modified = lubridate::today(),
         license = "https://creativecommons.org/licenses/by/4.0/legalcode")

# Save as .csv file
write_csv(IYS2022_bongo_event, here("standardized_data", "IYS2022_bongo_event.csv"))
```

Next, create the occurrence extensions - and then combine these. First the bongo occurrence data from the Shimada & NW Explorer:

```{r occurrence extension, eval = FALSE}
nw2022_bongo_occ <- nw2022_bongo_data %>%
  mutate(eventID = paste(station_event_id, net_number, sep = "-"),
         occurrenceID = paste(eventID, row_number(), sep = "-"),
         occurrenceStatus = "present",
         preparations = "Formalin")

shim2022_bongo_occ <- shim2022_bongo_data %>%
  mutate(eventID = paste(station_event_id, net_number, sep = "-"),
         occurrenceID = paste(eventID, row_number(), sep = "-"),
         occurrenceStatus = "present", 
         preparations = "Formalin")

# Combine these data frames:
shim_nw_bongo_occ <- rbind(nw2022_bongo_occ, shim2022_bongo_occ)
  
# Standardize columns to Darwin Core:
shim_nw_bongo_occ <- shim_nw_bongo_occ %>%
  rename(verbatimIdentification = species_recorded)

# From the scientific_name column, create identificationQualifier column, then remove 'SP.', and add 'sp. indet' for Neocalanus Flemingeri/plumchrus:
shim_nw_bongo_occ$identificationQualifier <- ifelse(grepl("\\b SP.\\b|\\b SP\\b", shim_nw_bongo_occ$scientific_name), "sp. indet.", NA)
shim_nw_bongo_occ$identificationQualifier <- ifelse(grepl("NEOCALANUS FLEMINGERI/PLUMCHRUS", shim_nw_bongo_occ$scientific_name), 
                                                    "sp. indet.", shim_nw_bongo_occ$identificationQualifier)
shim_nw_bongo_occ$scientific_name <- gsub("\\b SP.\\b|\\b SP\\b", "", shim_nw_bongo_occ$scientific_name) 

# Remove any special characters (punctuation, brackets etc)
shim_nw_bongo_occ$scientific_name <- gsub("[[:punct:]]", "", shim_nw_bongo_occ$scientific_name)

# Finally, remove any references to lifestage or sex from the scientific_name column, as this information is captured in separate columns already:
shim_nw_bongo_occ$scientific_name <- gsub(" LARVAE| JUVENILES| FURCILIA| BRACTS| NURSE| MEDIUM| SMALL| EXTRA SMALL| NAUPLII| ZOEA| CALYPTOPIS| AF| AM| V$| IV| III| II| I$", "", shim_nw_bongo_occ$scientific_name)

manual_check <- shim_nw_bongo_occ %>% select(scientific_name, verbatimIdentification, sex, lifestage, identificationQualifier) %>% distinct()

# scientific names are all capitalized. Change this from e.g. CYPHOCARIS CHALLENGERI to Cyphocaris challengeri:
shim_nw_bongo_occ$scientific_name <- tolower(shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- Hmisc::capitalize(shim_nw_bongo_occ$scientific_name)

# Check accuracy of scientific names:
worms_id <- worrms::wm_records_names(unique(shim_nw_bongo_occ$scientific_name), marine_only = FALSE) %>% dplyr::bind_rows() %>% rename(scientific_name = scientificname)

# Find out which species are not found in the WoRMS database:
no_worms_id <- left_join(shim_nw_bongo_occ, worms_id, by = "scientific_name") %>% filter(is.na(AphiaID)) %>% distinct(scientific_name)

# 7 names have to be changed to match WoRMS accepted names. These have to be changed in the original data table
shim_nw_bongo_occ$scientific_name <- gsub("Fish", "Pisces", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Metridia ochotensis", "Metridia okhotensis", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Neocalanus flemingeriplumchrus", "Neocalanus", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Squid", "Teuthida", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Gastropoda echinospira", "Gastropoda", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Siphonophora", "Siphonophorae", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Siphonophora bracts", "Siphonophorae", shim_nw_bongo_occ$scientific_name)
shim_nw_bongo_occ$scientific_name <- gsub("Oithona copepodids", "Oithona", shim_nw_bongo_occ$scientific_name)

# As we have now changed all the names in the original dataframe to fit the entries in the WoRMS database registry, we can use wm_records_names() again to find all the taxonomic information. 
shim_nw_bongo_worms_id <- worrms::wm_records_names(unique(shim_nw_bongo_occ$scientific_name), marine_only = FALSE) %>%
  dplyr::bind_rows() %>% rename(scientific_name = scientificname)

# After manual inspection, there are some AphiaIDs that need to be removed, as the species is listed multiple times.
shim_nw_bongo_worms_id <- filter(shim_nw_bongo_worms_id, !(AphiaID %in% c("534090", "999078")))

shim_nw_bongo_occ <- left_join(shim_nw_bongo_occ, shim_nw_bongo_worms_id, by = "scientific_name") 

shim_nw_bongo_final <- shim_nw_bongo_occ %>%
  select(verbatimIdentification, 
         lifeStage = lifestage, 
         sex, eventID, 
         individualCount = catch_count,
         organismQuantity = abundance_m3,
         scientificName = scientific_name,
         taxonomicAuthority = authority,
         taxonomicStatus = status,
         taxonomicRank = rank,
         kingdom, phylum, class, order, family, genus, 
         scientificNameID = lsid,
         occurrenceID, occurrenceStatus, preparations, identificationQualifier) %>%
  mutate(specificEpithet = stringr::word(scientificName, 2),
         organismQuantityType = "individuals per cubic meter")

# Remove NAs from the dataframe:
shim_nw_bongo_final[is.na(shim_nw_bongo_final)] <- ""
shim_nw_bongo_final <- as.data.frame(shim_nw_bongo_final)
```

Next, the Bongo data collected by the TINRO, which is provided in a different format: 

```{r TINRO bongo}
tinro2022_bongo_counts <- tinro2022_bongo_data[-c(1:4, 149:295),]
tinro2022_bongo_abund <- tinro2022_bongo_data[-c(1:151),]

tinro2022_bongo_counts <- tinro2022_bongo_counts %>%
  pivot_longer(cols = `1`:`32`,
               values_to = "counts",
               names_to = "station") 

tinro2022_bongo_abund <- tinro2022_bongo_abund %>%
  pivot_longer(cols = `1`:`32`,
               values_to = "ind/m3",
               names_to = "station")

tinro2022_bongo_occ <- left_join(tinro2022_bongo_counts, tinro2022_bongo_abund)

tinro2022_bongo_occ$station <- as.numeric(tinro2022_bongo_occ$station)
tinro2022_bongo_occ <- tinro2022_bongo_occ[order(tinro2022_bongo_occ$station),]
tinro2022_bongo_occ <- tinro2022_bongo_occ %>% rename(verbatimIdentification = `Station No`)
```

In the _Stage/length_ column, size ranges, sex and lifestages are sometimes included. We need to parse these out and include them in separate columns. If numerical values are included, these need to be included in a `size_range` column. If sex is included in the scientific name (i.e. 'AF' for adult female), include this in column `sex`. Lifestage, such as 'adult' (A) need to be included in `lifeStage` column.

```{r TINRO bongo cont}
tinro2022_bongo_occ <- tinro2022_bongo_occ %>%
  mutate(size_range = ifelse(grepl("\\d+", `Stage/length`), `Stage/length`, NA), 
         `Stage/length` = ifelse(grepl("\\d+", `Stage/length`), NA, `Stage/length`),
         sex = ifelse(grepl("F", `Stage/length`), "female", 
                      ifelse(grepl("M", `Stage/length`), "male", NA)), 
         `Stage/length` = ifelse(grepl("A", `Stage/length`), "Adult", `Stage/length`)) %>% 
  rename(lifeStage = `Stage/length`) %>%
  mutate(eventID = paste("IYS2022", "TINRO", "3", station, "Bongo", "1", sep = "-"))

# Size (ranges) in the verbatimIdentification should also be included in the size_range column
tinro2022_bongo_occ <- tinro2022_bongo_occ %>%
  mutate(size_range = ifelse(grepl("0.5mm", verbatimIdentification), "0.5mm", size_range),
         size_range = ifelse(grepl("1.5mm", verbatimIdentification), "1.5mm", size_range),
         size_range = ifelse(grepl("2.5mm", verbatimIdentification), "2.5mm", size_range),
         size_range = ifelse(grepl("1mm", verbatimIdentification), "1mm", size_range))

# Lifestages in the verbatimidentification should also be included in the lifeStage column:
tinro2022_bongo_occ <- tinro2022_bongo_occ %>%
  mutate(lifeStage = ifelse(grepl("larvae", verbatimIdentification), "larvae", lifeStage),
         lifeStage = ifelse(grepl("juv.", verbatimIdentification), "juvenile", lifeStage),
         lifeStage = ifelse(grepl("fur", size_range), "furcilia", lifeStage),
         lifeStage = ifelse(grepl("egg", verbatimIdentification), "egg", lifeStage),
         lifeStage = ifelse(grepl("Crytoniscid", verbatimIdentification), "crytoniscid larva", lifeStage),
         lifeStage = ifelse(grepl("Microniscid", verbatimIdentification), "microniscid larva", lifeStage))

# Create column 'identificationQualifier' to indicate uncertainty in species classification:
tinro2022_bongo_occ$identificationQualifier <- ifelse(grepl("\\b sp.|spp.", tinro2022_bongo_occ$verbatimIdentification), "sp. indet.", NA)
tinro2022_bongo_occ$identificationQualifier <- ifelse(grepl("Neocalanus plumchrus/flemmingi", tinro2022_bongo_occ$verbatimIdentification),
                                                      "sp. indet.", tinro2022_bongo_occ$identificationQualifier)

# Next, duplicate the verbatimIdentification column so that we can make changes where necessary to the scientific names based on the WoRMS Registry:
tinro2022_bongo_occ$scientific_name <- tinro2022_bongo_occ$verbatimIdentification

# From this duplicated column, remove 'sp.' and 'spp.' to begin with;
tinro2022_bongo_occ$scientific_name <- gsub("\\b sp.\\b|\\b spp.\\b|\\b SP.\\b", "", tinro2022_bongo_occ$scientific_name) 

# Manual check to see if those changes have been made correctly:
manual_check <- tinro2022_bongo_occ %>% select(scientific_name, verbatimIdentification, sex, lifeStage, identificationQualifier, size_range) %>% distinct()

# Remove any special characters (punctuation, brackets etc)
tinro2022_bongo_occ$scientific_name <- gsub("[[:punct:]]", "", tinro2022_bongo_occ$scientific_name)

# Check accuracy of scientific names:
worms_id <- worrms::wm_records_names(unique(tinro2022_bongo_occ$scientific_name), marine_only = FALSE) %>% dplyr::bind_rows() %>% rename(scientific_name = scientificname)

# Find out which species are not found in the WoRMS database:
no_worms_id <- left_join(tinro2022_bongo_occ, worms_id, by = "scientific_name") %>% filter(is.na(AphiaID)) %>% distinct(scientific_name)

# 34 names have to be changed to match WoRMS accepted names. These have to be changed in the original data table (tinro2022_bongo_occ)
tinro2022_bongo_occ$scientific_name <- gsub("Scolethricella minor", "Scolecithricella minor", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Scolethricella ovata", "Scolecithricella ovata", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Gaetanus intermedius", "Gaetanus simplex", tinro2022_bongo_occ$scientific_name) # As per A. Pinchuk
tinro2022_bongo_occ$scientific_name <- gsub("Siphonophora", "Siphonophorae", tinro2022_bongo_occ$scientific_name) # As per A. Pinchuk
tinro2022_bongo_occ$scientific_name <- gsub("Neocalanus plumchrusflemmingi", "Neocalanus", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Eucheata elongata", "Euchaeta elongata", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Candacia columbia", "Candacia columbiae", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Clausocalanus sp  really small 05mm  tiny 5th leg AF voucher", "Clausocalanus", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Clausocalanus sp  15mm  tiny 5th leg AF voucher", "Clausocalanus", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Clausocalanus sp 1mm", "Clausocalanus", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Clausocalanus sp 25mm", "Clausocalanus", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Mesocalanus tenniucornus", "Mesocalanus tenuicornis", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Acartia longirmis", "Acartia longiremis", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Lucicutia 15mm", "Lucicutia", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Hyperia juv", "Hyperia", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Thysanoesa inspinata", "Thysanoessa inspinata", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Thysanoesa spinifer", "Thysanoessa spinifera", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Thysanoesa inermis", "Thysanoessa inermis", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Thysanoesa longipes", "Thysanoessa longipes", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Chionocetes", "Chionoecetes", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Crytoniscid parasitic isopod larvae", "Isopoda", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Microniscid parasitic isopod larvae", "Isopoda", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Polycheata", "Polychaeta", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Tyroscrolex leafy stick", " ", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Limiacina helicina", "Limacina helicina", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Squid larvae", "Teuthida", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Eukronia hamata", "Eukrohnia hamata", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Sagitta scrippae  larger transparent fellow", "Sagitta scrippsae", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Oikopluera", "Oikopleura", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Fritilaria", "Fritillaria", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Siphonophore bract", "Siphonophorae", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Jelly fragments", "Cnidaria", tinro2022_bongo_occ$scientific_name) #TODO: Confirm this is correct
tinro2022_bongo_occ$scientific_name <- gsub("Fish egg", "Pisces", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Fish larvae", "Pisces", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Brozoan cyphonautes", "Bryozoa", tinro2022_bongo_occ$scientific_name)
tinro2022_bongo_occ$scientific_name <- gsub("Pumkin boy unknown critter could be sea anemone larvae", "Zoanthidea", tinro2022_bongo_occ$scientific_name) # As per A. Pinchuk

# As we have now changed all the names in the original dataframe to fit the entries in the WoRMS database registry, we can use wm_records_names() again to find all the taxonomic information. 
tinro2022_bongo_worms_id <- worrms::wm_records_names(unique(tinro2022_bongo_occ$scientific_name), marine_only = FALSE) %>%
  dplyr::bind_rows() %>% rename(scientific_name = scientificname)

# After manual inspection, there are some AphiaIDs that need to be removed, as the species is listed multiple times.
tinro2022_bongo_worms_id <- filter(tinro2022_bongo_worms_id, !(AphiaID %in% c("534090", "835292", "503291")))

# Check to see if we missed any:
unique_taxa <- as.data.frame(unique(tinro2022_bongo_occ$scientific_name))
names(unique_taxa)[1] <- "scientific_name"
temp_taxa <- left_join(unique_taxa, tinro2022_bongo_worms_id) %>% filter(is.na(AphiaID)) # should be empty.
print(temp_taxa)

tinro2022_bongo_occ <- left_join(tinro2022_bongo_occ, tinro2022_bongo_worms_id, by = "scientific_name") %>%
  group_by(eventID) %>%
  mutate(id = seq_along(eventID)) %>%
  mutate(occurrenceID = paste(eventID, id, sep = "-"),
         occurrenceStatus = "present",
         preparations = "Formalin")

tinro2022_bongo_final <- tinro2022_bongo_occ %>%
  select(verbatimIdentification, lifeStage, sex, eventID, identificationQualifier, 
         individualCount = counts,
         organismQuantity = `ind/m3`,
         scientificName = scientific_name,
         taxonomicAuthority = authority,
         taxonomicStatus = status,
         taxonomicRank = rank,
         kingdom, phylum, class, order, family, genus, 
         scientificNameID = lsid,
         occurrenceID, occurrenceStatus, preparations) %>%
  mutate(specificEpithet = stringr::word(scientificName, 2),
         organismQuantityType = "individuals per cubic meter")

# Remove NAs from the dataframe:
tinro2022_bongo_final[is.na(tinro2022_bongo_final)] <- ""
tinro2022_bongo_final <- as.data.frame(tinro2022_bongo_final)
```

Combine these occurrence extensions into a single dataframe and save locally:

```{r IYS2022 bongo}
IYS2022_bongo_final <- plyr::rbind.fill(shim_nw_bongo_final, tinro2022_bongo_final) %>% as.data.frame()

# Replace N/A with blanks in the sex and lifestage column:
IYS2022_bongo_final$lifeStage <- stringr::str_replace_all(IYS2022_bongo_final$lifeStage, "[[:punct:]]", "")
IYS2022_bongo_final$lifeStage <- gsub("NA", "", IYS2022_bongo_final$lifeStage)

IYS2022_bongo_final$sex <- stringr::str_replace(IYS2022_bongo_final$sex, "[[:punct:]]", "")
IYS2022_bongo_final$sex <- gsub("NA", "", IYS2022_bongo_final$sex)

# Save as .csv file
write_csv(IYS2022_bongo_final, here("standardized_data", "IYS2022_bongo_occ.csv"))

# I will also generate a small occ file with the unique species occurrences, to manually check that I've made the necessary changes:
occ_manual_check <- IYS2022_bongo_final %>%
  select(verbatimIdentification, scientificName, sex, lifeStage, identificationQualifier) %>% distinct()

write_csv(occ_manual_check, here("standardized_data", "occ_manual_check.csv"))
```

We want to standardize the data as well for the IYS Data Template. To put it in that format, combine the Event Core and occurrence extension and select and rename the correct columns:

```{r IYS Template, eval = FALSE}
bongo2022_template <- left_join(IYS2022_bongo_event, IYS2022_bongo_final, by = "eventID") %>%
  select(station_event_id = eventID,
         catch_id = occurrenceID,
         species_recorded = verbatimIdentification,
         scientific_name = scientificName,
         taxonomic_rank = taxonomicRank,
         lifestage = lifeStage,
         sex,
         preservation_method = preparations,
         catch_count = individualCount,
         abundance_m3 = organismQuantity,
         flowmeter_volume_filtered_m3 = sampleSizeValue) %>%
  mutate(net_number = 1,
         prop_total_sample = "",
         sf_proc = "",
         common_name = "",
         identified_by = "",
         date_identified = "",
         count_method = "Total", #TODO: confirm this
         depth_volume_filtered_m3 = "",
         comments = "") #TODO: this could be 'occurrenceRemarks'

# Drop rows where abundance_m3 is 0
bongo2022_template <- bongo2022_template %>% filter(!abundance_m3 == 0)

# Compared to the 2019 and 2020 data, we should still include information on the proportion of the sample processed when doing taxonomy for each size fraction (prop_sf_proc). This information is included in the zoop data_raw counts sheet:

sf <- read_excel(here("original_data", "7-14 2022 Bongo Logbook-TINRO_clean.xlsx"), sheet = "zoop data_raw counts")
sf <- sf[-c(1:6),]

# Select species column
sf_species <- sf[, 1]

# Select only the columns where `total counted per split` is NA, as these columns depict the proportion size fractionated:
col_odd <- seq_len(ncol(sf)) %% 2
sf <- sf[ , col_odd == 0]

# Combine species column with columns associated with the proportion size fractionated:
new_sf <- cbind(sf_species, sf)

# Change column headers, and adjust class where necessary:
new_sf <- setNames(new_sf, c("species_recorded", "Stage/length", "1", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12",
                             "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32"))

new_sf$`1` <- as.numeric(new_sf$`1`)

# pivot long:
new_sf <- new_sf %>%
  pivot_longer(cols = 3:33,
               values_to = "prop_sf_proc",
               names_to = "station") %>%
  mutate(station_event_id = paste("IYS2022", "TINRO", "3", station, "Bongo", "1", sep = "-")) %>%
  drop_na(prop_sf_proc)

# Parse out `Stage/length` column into two separate columns. We have to do this to properly match prop_sf_proc to the correct species/sex/lifestage combination.
new_sf <- new_sf %>%
  mutate(size_range = ifelse(grepl("\\d+", `Stage/length`), `Stage/length`, NA), 
         `Stage/length` = ifelse(grepl("\\d+", `Stage/length`), NA, `Stage/length`), 
         sex = ifelse(grepl("F", `Stage/length`), "female", 
                      ifelse(grepl("M", `Stage/length`), "male", NA)), 
         `Stage/length` = ifelse(grepl("A", `Stage/length`), "Adult", `Stage/length`)) %>% 
  rename(lifestage = `Stage/length`) %>%
  select(species_recorded, lifestage, prop_sf_proc, station_event_id, sex)

# Lifestages in the verbatimidentification should also be included in the lifeStage column:
new_sf <- new_sf %>%
  mutate(lifestage = ifelse(grepl("larvae", species_recorded), "larvae", lifestage),
         lifestage = ifelse(grepl("juv.", species_recorded), "juvenile", lifestage),
         lifestage = ifelse(grepl("egg", species_recorded), "egg", lifestage))

# Remove NAs from the dataframe:
new_sf[is.na(new_sf)] <- ""
new_sf <- as.data.frame(new_sf)

# Integrate within the IYS Data Template:
bongo2022_template <- left_join(bongo2022_template, new_sf, by = c("species_recorded", "station_event_id", "lifestage", "sex"))

col_order <- c("station_event_id", "net_number", "catch_id", "species_recorded", "scientific_name", "taxonomic_rank", "prop_total_sample", "sf_proc", "prop_sf_proc",
               "lifestage", "sex", "common_name", "identified_by", "date_identified", "preservation_method", "catch_count", "count_method", "abundance_m3",
               "flowmeter_volume_filtered_m3", "depth_volume_filtered_m3", "comments")
bongo2022_template <- bongo2022_template[, col_order]

# Save locally:
write_csv(bongo2022_template, here("IYS_data_template", "IYS2022_Bongo.csv"))
```

Finally, develop the extended measurements or facts extensions and combine them.

Bottom depth:

```{r bottom_depth, eval = FALSE}
bongo2022_bottomdepth <- tinro2022_bongo_event %>%
  select(eventID,
         Depth_m) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = Depth_m,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementType = recode(measurementType,
                                 Depth_m = "bottom_depth"),
         measurementID = paste(eventID, measurementType, sep = "-")) %>%
  mutate(measurementTypeID = case_when(
    measurementType == "bottom_depth" ~ "http://vocab.nerc.ac.uk/collection/C00/current/SCILOG/"),
         measurementUnit = case_when(
    measurementType == "bottom_depth" ~ "meter"),
         measurementUnitID = case_when(
    measurementUnit == "meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/ULAA/"),
    measurementValueID = NA) %>%
  select(eventID, measurementID, measurementType, measurementTypeID, measurementValue, measurementValueID,
         measurementUnit, measurementUnitID)
```

Sampling effort:

``` {r sampling effort, eval = FALSE}
bongo2022_sampling <- tinro2022_bongo_event %>%
  select(eventID, 
         `Vol filtered (m^3)`) %>%
  mutate(speed_tow = 1) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = `Vol filtered (m^3)`:speed_tow,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementType = recode(measurementType,
                                 `Vol filtered (m^3)` = "volume_filtered"),
         measurementID = paste(eventID, measurementType, sep = "-"),
         measurementTypeID = case_when(
           measurementType == "volume_filtered" ~ "http://vocab.nerc.ac.uk/collection/P09/current/VOLF/", 
           measurementType == "speed_tow" ~ "http://vocab.nerc.ac.uk/collection/P01/current/TOWSPEED/"),
  measurementUnit = case_when(
    measurementType == "volume_filtered" ~ "cubic meter",
    measurementType == "speed_tow" ~ "meter per second"),
  measurementUnitID = case_when(
    measurementUnit == "cubic meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/MCUB/",
    measurementUnit == "meter per second" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UVAA/"),
  measurementValueID = NA) %>%
    select(eventID, measurementID, measurementType, measurementTypeID, measurementValue, measurementValueID,
           measurementUnit, measurementUnitID)
```

Next, add information on the _sampling instrument_. Information on the mesh size and sampling instrument opening came from the Cruise Report and is verified by the data provider. 

``` {r samplingInstrument, eval = FALSE}
bongo2022_instrument <- tinro2022_bongo_event %>%
  select(eventID,
         Gear) %>%
  mutate(bongo_mesh = 236,
         bongo_opening = 0.6) %>%
  distinct(eventID, .keep_all = TRUE) %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = Gear:bongo_opening,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementID = paste(eventID, "bongo", measurementType, sep = ":"),
         measurementTypeID = case_when(
           measurementType == "Gear" ~ "http://vocab.nerc.ac.uk/collection/Q01/current/Q0100002/",
           measurementType == "bongo_mesh" ~ "http://vocab.nerc.ac.uk/collection/Q01/current/Q0100015/",
           measurementType == "bongo_opening" ~ "http://vocab.nerc.ac.uk/collection/Q01/current/Q0100017/"))

bongo2022_instrument <- bongo2022_instrument %>%
  mutate(measurementUnit = case_when(
           measurementType == "bongo_mesh" ~ "micrometer",
           measurementType == "bongo_opening" ~ "square meter"),
         measurementUnitID = case_when(
           measurementUnit == "micrometer" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UMIC/",
           measurementUnit == "square meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UMSQ/"),
         measurementValueID = case_when(
           measurementValue == "Bongo" ~ "http://vocab.nerc.ac.uk/collection/L22/current/NETT0176/")) %>%
  select(eventID, measurementID, measurementType, measurementTypeID, measurementValue,
         measurementValueID, measurementUnit, measurementUnitID)
```

Next, we create the eMOF extension to associate the length, lifestage and sex measurements to the zooplankton.  

```{r eMOF, eval = FALSE}
bongo2022_emof <- tinro2022_bongo_occ %>%
  select(eventID,
         occurrenceID,
         lifeStage,
         sex,
         `ind/m3`, 
         size_range) %>%
  mutate_all(as.character)
```

```{r specimen size range, eval = FALSE}
#TODO: Create code to parse out size ranges into separate columns

range <- dplyr::filter(bongo2022_emof, grepl("-", size_range)) %>%
  separate(col = size_range, into = c("minimumLength", "maximumLength"), sep = "\\-") %>%
  mutate(size_range = " ")

# Remove any rows where length_mm contains a range, add two dummy columns (minimumLength and maximumLength) and use rbind() to merge `range` with this newly created dataframe.
minimum <- dplyr::filter(bongo2022_emof, grepl("\\+|>", size_range)) %>%
  mutate(minimumLength = as.character(unlist(regmatches(size_range, 
                                                      gregexpr("[[:digit:]]+\\.*[[:digit:]]*", size_range)))),
         maximumLength = " ")

temp <- bongo2022_emof[ -grep("\\+|>|-", bongo2022_emof$size_range), ] %>%
  mutate(minimumLength = " ",
         maximumLength = " ")

bongo2022_emof_fnl <- rbind(range, minimum, temp)

# Remove 'mm' from the size (range) columns:
bongo2022_emof_fnl[c("minimumLength", "maximumLength", "size_range")] <- lapply(bongo2022_emof_fnl[c("minimumLength", "maximumLength", "size_range")], function(y) gsub("mm", "", y))

# Make some adjustments:
bongo2022_emof_fnl$length_type <- ifelse(grepl("shell", bongo2022_emof_fnl$maximumLength), "shell length", NA)
bongo2022_emof_fnl$maximumLength <- gsub("[[:punct:]]", "", bongo2022_emof_fnl$maximumLength)
bongo2022_emof_fnl$maximumLength <- gsub(" shell length", "", bongo2022_emof_fnl$maximumLength)

#Remove 'fur' from minimumLength and add it to lifeStage column
bongo2022_emof_fnl$lifeStage <- ifelse(grepl("fur", bongo2022_emof_fnl$minimumLength), "furcilia", bongo2022_emof_fnl$lifeStage)
bongo2022_emof_fnl$minimumLength <- gsub("fur", "", bongo2022_emof_fnl$minimumLength)

# Remove 'lar' from size_range and add it to lifeStage column
bongo2022_emof_fnl$lifeStage <- ifelse(grepl("lar", bongo2022_emof_fnl$size_range), "larvae", bongo2022_emof_fnl$lifeStage)
bongo2022_emof_fnl$size_range <- gsub("lar", "", bongo2022_emof_fnl$size_range)

#TODO: Figure out what to do with 'Megalopa' in the Stage/Length column:

#Extract only sizes (numerical values) from size_range, remove all characters.
bongo2022_emof_fnl$size_range <- extract_numeric(bongo2022_emof_fnl$size_range)
```

So then finally the eMOF:

```{r emof cont., eval = FALSE}
bongo2022_emof_fnl <- bongo2022_emof_fnl %>%
  mutate_all(as.character) %>%
  pivot_longer(cols = lifeStage:length_type,
               names_to = "measurementType",
               values_to = "measurementValue") %>%
  mutate(measurementID = paste(occurrenceID, measurementType, sep = "-"),
    measurementTypeID = case_when(
      measurementType == "size_range" ~ "http://vocab.nerc.ac.uk/collection/P01/current/OBSINDLX/",
      measurementType == "maximumLength" ~ "http://vocab.nerc.ac.uk/collection/P01/current/OBSMAXLX/",
      measurementType == "minimumLength" ~ "http://vocab.nerc.ac.uk/collection/P01/current/OBSMINLX/",
      measurementType == "lifeStage" ~ "http://vocab.nerc.ac.uk/collection/P01/current/LSTAGE01/",
      measurementType == "sex" ~ "http://vocab.nerc.ac.uk/collection/P01/current/ENTSEX01/",
      measurementType == "ind/m3" ~ "http://vocab.nerc.ac.uk/collection/P01/current/SDBIOL01/",
      measurementType == "length_type" ~ " "), 
    measurementUnit = case_when(
      measurementType %in% c("length", "minimumLength", "maximumLength") ~ "millimeter",
      measurementType == "ind/m3" ~ "individuals per cubic meter"), 
    measurementUnitID = case_when(
      measurementUnit == "millimeter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UXMM/",
      measurementUnit == "individuals per cubic meter" ~ "http://vocab.nerc.ac.uk/collection/P06/current/UPMM/"),
    measurementValueID = case_when(
      measurementValue == "male" ~ "http://vocab.nerc.ac.uk/collection/S10/current/S103/",
      measurementValue == "female" ~ "http://vocab.nerc.ac.uk/collection/S10/current/S102/",
      measurementValue == "Adult" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1116/",
      measurementValue == "V" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1112/",
      measurementValue == "IV" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1110/",
      measurementValue == "IV-V" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1111/",
      measurementValue == "III" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S118/",
      measurementValue == "II" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S117/",
      measurementValue == "I" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S111/",
      measurementValue == "juvenile" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1127/",
      measurementValue == "furcilia" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1123/",
      measurementValue == "egg" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1122/",
      measurementValue == "nauplii" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1130/",
      measurementValue == "cal" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1118/",
      measurementValue == "larvae" ~ "http://vocab.nerc.ac.uk/collection/S11/current/S1128/",
      measurementValue == "Megalopa" ~ "https://vocab.nerc.ac.uk/collection/S11/current/S1167/"),
    measurementRemarks = NA) %>%
  drop_na(measurementValue)

bongo2022_tinro_emof <- bind_rows(bongo2022_bottomdepth, bongo2022_sampling, bongo2022_instrument, bongo2022_emof_fnl)

# Make sure the folder path exists already (e.g. ./Bongo/tidy_data)
write_csv(bongo2022_tinro_emof, here("standardized_data", "bongo2022_tinro_emof.csv"))
```









